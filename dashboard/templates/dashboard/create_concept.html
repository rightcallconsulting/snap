{% extends 'dashboard/base.html' %}
{% load staticfiles %}

{% block content %}
	<div id="create-concept" class="create-concept padding-md">
		<div id="help-box" hidden="true">
			<strong>Help:</strong> Click on players in the player bar to add them to the concept and then drag them into position. Enter a concept name in the header and then click on the check mark to save a new concept. Select a current concept from the list of existing concepts to edit it or use it as a starting point for a new concept. If you save a concept with the same name as a current concept that concept will be overwritten, otherwise a new concept will be saved. To delete a current concept select it from the list of existing concepts and click on the trash can without changing the concept's name.
			<br><br>
			Select a player in the concept by clicking on them and then add assignments using the mouse and keyboard. Change the type of assignment by clicking the top buttons or using the 'A' key for quarterback dropbacks, the 'S' key for pre-snap motion, the 'D' key for runs, the 'F' key for routes, and the 'G' key for blocking assignments. All assignments can be created by selecting that button and then clicking anywhere on the field. If blocks are selected you can also click on a defensive player to specify that player as an assignment. Additionally, the 'Q', 'W', 'E', 'R', 'T', 'Y', and 'U' keys are shortcuts for adding different predefined blocks.
		</div>

		<div id="notes-and-calls-input" class="col-md-12" hidden="true">
			<div><textarea id="note" class="snap-input snap-textarea" rows="3" cols="35"></textarea></div>
			<div><button id="add-note-button" class="btn btn-success">Add Note</button></div>
			<div><input id="call" class="snap-input snap-text" type="text" maxlength="50"></div>
			<div><button id="add-call-button" class="btn btn-success">Add Call</button></div>
		</div>

		<div id="display-box" class="col-md-8 col-sm-12 bordered-div">
			<div id="header-box" class="interactive-header display-header placeholder">
				<p id="placeholder-message">Enter Concept Name</p>
			</div>

			<div id="quiz-box">
			</div>

			<div class="mainview-buttons">
				<button id="save-button" name="button">
					<i class="fa fa-check fa-2x mainview-button-icon" title="Save Concept"></i>
				</button>

				<button id="delete-button" name="button">
					<i class="fa fa-trash-o fa-2x mainview-button-icon" title="Delete Concept"></i>
				</button>

				<button id="zoom-in-button" name="button">
					<i class="fa fa-search-plus fa-2x mainview-button-icon" title="Zoom in"></i>
				</button>

				<button id="zoom-out-button" name="button">
					<i class="fa fa-search-minus fa-2x mainview-button-icon" title="Zoom out"></i>
				</button>

				<button id="help-button" name="button">
					<i class="fa fa-question-circle-o fa-2x mainview-button-icon" title="Help"></i>
				</button>
			</div>
		</div>

		<div id="sideview" class="col-md-3">
			<div id="sideview-header">
				Existing Concepts
			</div>
			<div id="sideview-buttons">
				{% for concept in concepts %}
					<button class="btn btn-primary sideview-button" name="{{ concept.name }}" onclick="changeSelectedConcept(this)">
						{{ concept.name }}
					</button>
				{% endfor %}
			</div>
		</div>

		<div id="notes-and-calls" class="col-md-12" hidden="true">
			<div id="concept-notes" class="col-md-4">
				<h3 id="concept-notes-header">Notes for Concept</h3>
				<ul id="concept-notes-list">
				</ul>
			</div>

			<div id="calls" class="col-md-4">
				<h3 id="calls-header">Calls for Positions in Concept</h3>
				<ul id="calls-list">
				</ul>
			</div>

			<div id="player-notes" class="col-md-4">
				<h3 id="player-notes-header">Notes for Player</h3>
				<ul id="player-notes-list">
				</ul>
			</div>
		</div>

	<div id="test-id" test-id="{{test.id}}" style="display: none;"></div>
	<div id="team-id" team-id="{{team.id}}" style="display: none;"></div>
	<div id="player-id" player-id="{{player.id}}" style="display: none;"></div>
{% endblock %}

{% block javascript %}
	<script src="{% static 'dashboard/js/jquery-1.10.2.min.js' %}"></script>
	<script type="text/javascript">
		var concepts = [];
		var concept;
		var buttons = [];
		var defensivePlayerBar;
		var offensivePlayerBar;
		var playerBeingDragged;
		var mouseBeingDragged = false;
		var selectedPlayerStatus = 0; //0 - blocker, 1 - route, 2 - motion
		var teamID = document.getElementById("team-id").getAttribute("team-id");

		//*******************************************************************//
		// p5.js Animation Functions                                         //
		//*******************************************************************//

		function setup() {
			var display_box = document.getElementById("display-box");
			var display_box_header = display_box.querySelector(".display-header");
			var display_box_footer = display_box.querySelector(".mainview-buttons");
			var sideview = document.getElementById("sideview");
			var height = sideview.offsetHeight - (display_box_header.offsetHeight + display_box_footer.offsetHeight);

			// 4px is the combined size of the borders on either side. What is a better way to do this?
			var width = display_box.offsetWidth - 4;

			// Create canvas and add it to the main view
			var quiz_box_div = document.getElementById("quiz-box");
			var myCanvas = createCanvas(width, height);

			field.height = height;
			field.width = width;
			field.heightInYards = 35;
			field.ballYardLine = 65;
			background(58, 135, 70);

			myCanvas.parent("quiz-box");

			// Load concepts from Json passed from database
			var conceptJsonFromDatabase = "";

			{% for concept in concepts %}
			conceptJsonFromDatabase = '{{ concept.conceptJson|safe }}';
			concepts.push(createConceptFromJson(JSON.parse(conceptJsonFromDatabase)));
			{% endfor %}

			// Create new Concept
			concept = new Concept({});

			// Create Player bars
			defensivePlayerBar = new PlayerBar({
				playerOptions: createDefensivePlayerOptions()
			});
			defensivePlayerBar.init(field);

			offensivePlayerBar = new PlayerBar({
				playerOptions: createOffensivePlayerOptions()
			});
			offensivePlayerBar.y = field.height - offensivePlayerBar.height;
			offensivePlayerBar.init(field);

			// Create buttons for selecting type of assignment
			var button = new Button ({ label: "Dropback (A)" });
			buttons.push(button);

			button = new Button ({ label: "Motion (S)" });
			buttons.push(button);

			button = new Button ({ label: "Run (D)" });
			buttons.push(button);

			button = new Button ({ label: "Route (F)" });
			buttons.push(button);

			button = new Button ({ label: "Block (G)" });
			buttons.push(button);

			var button = new Button ({ label: "Movement (A)" });
			buttons.push(button);

			button = new Button ({ label: "Rush/Blitz (S)" });
			buttons.push(button);

			button = new Button ({ label: "Man Coverage (D)" });
			buttons.push(button);

			button = new Button ({ label: "Zone Coverage (F)" });
			buttons.push(button);

			updateNotesAndCalls();

			window.onresize = function() {
				var display_box = document.getElementById("display-box");
				var display_box_header = display_box.querySelector(".display-header");
				var display_box_footer = display_box.querySelector(".display-buttons");
				var sideview = document.getElementById("sideview");
				var height = sideview.offsetHeight - (display_box_header.offsetHeight + display_box_footer.offsetHeight);
				var width = display_box.offsetWidth - 4;

				resizeCanvas(width, height);
				field.height = height;
				field.width = width;

				resizeMainViewObjects();
			};

			drawOpening();
		};

		function draw() {
			// Limitations on where offensive players can be
			var numberOfOffensivePlayers = concept.offensivePlayers.length;

			for (var i = 0; i < numberOfOffensivePlayers; ++i) {
				var player = concept.offensivePlayers[i];
				var playerXPixel = field.getTranslatedX(player.x);
				var playerYPixel = field.getTranslatedY(player.y);
				var playerXYard = player.x;
				var playerYYard = player.y;

				// Keep the players within the screen
				if (playerXPixel < 0) {
					player.x = field.getYardX(0);
				} else if (playerXPixel > field.width) {
					player.x = field.getYardX(field.width);
				}

				if (playerYPixel < 0) {
					player.y = player.getYardY(0);
				} else if (playerYPixel > field.height) {
					player.y = player.getYardY(field.height)
				}

				// Keep the players on the field
				if (playerXYard < 0) {
					player.x = 0;
				} else if (playerXYard > 53.33) {
					player.x = 53.33;
				}

				if (playerYYard < -10) {
					player.y = 0;
				} else if (playerYYard > field.ballYardLine) {
					player.y = field.ballYardLine;
				}

				// If a player is ineligible they must be on the line of scrimmage.
				// Otherwise if they are within a yard of the line of scrimmage they
				// should automatically snap onto the line.
				if (!player.eligible) {
					player.y = field.ballYardLine;
				} else {
					if (player.y > field.ballYardLine - 1) {
						player.y = field.ballYardLine;
					}
				}
			}

			// Limitations on where defensive players can be
			var numberOfDefensivePlayers = concept.defensivePlayers.length;

			for (var i = 0; i < numberOfDefensivePlayers; ++i) {
				var player = concept.defensivePlayers[i];
				var playerXPixel = field.getTranslatedX(player.x);
				var playerYPixel = field.getTranslatedY(player.y);
				var playerXYard = player.x;
				var playerYYard = player.y;

				// Keep the players within the screen
				if (playerXPixel < 0) {
					player.x = field.getYardX(0);
				} else if (playerXPixel > field.width) {
					player.x = field.getYardX(field.width);
				}

				if (playerYPixel < 0) {
					player.y = player.getYardY(0);
				} else if (playerYPixel > field.height) {
					player.y = player.getYardY(field.height)
				}

				// Keep the players on the field
				if (playerXYard < 0) {
					player.x = 0;
				} else if (playerXYard > 53.33) {
					player.x = 53.33;
				}

				if (playerYYard < field.ballYardLine+player.siz) {
					player.y = field.ballYardLine+player.siz;
				} else if (playerYYard > 110) {
					player.y = 110;
				}
			}

			// Determine which buttons should be displayed based on which, if
			// any buttons should be displayed.
			var player = concept.getSelected()[0];

			if (player != null && player.unit === "offense") {
				for (i in buttons) {
					buttons[i].display = false;
				}

				if (player.dropback.length > 0) {
					buttons[0].display = true;
				} else if (player.run.length > 0) {
					buttons[2].display = true;
				} else if (player.route.length > 0) {
					buttons[3].display = true;
				} else if (player.blockingAssignmentArray.length > 0) {
					buttons[4].display = true;
				} else if (player.pos === "QB") {
					buttons[0].display = true;
					buttons[1].display = true;
					buttons[2].display = true;
					buttons[3].display = true;
					buttons[4].display = true;
				} else if (player.eligible === true) {
					buttons[1].display = true;
					buttons[2].display = true;
					buttons[3].display = true;
					buttons[4].display = true;
				} else if (player.eligible === false) {
					buttons[4].display = true;
				}
			} else if(player != null && player.unit === "defense") {
				for (i in buttons) {
					buttons[i].display = false;
				}
				buttons[5].display = true;
				buttons[6].display = true;
				buttons[7].display = true;
				buttons[8].display = true;
			}else{
				for (i in buttons) {
					buttons[i].setUnclicked();
					buttons[i].display = false;
				}
			}

			// Draw opening
			drawOpening();
		};

		function drawButtons() {
			var x = 10;
			var y = 45;

			for (i in buttons) {
				if (buttons[i].display === true) {
					buttons[i].x = x;
					buttons[i].y = y;

					buttons[i].draw(field);

					x += buttons[i].width*1.25;
				}
			}
		}

		function drawOpening() {
			field.drawBackground(concept, height, width);

			//drawDebuggingInfo(); // uncomment this to have the canvas display some useful information

			concept.drawAssignments(field);
			concept.drawPlayers(field);
			defensivePlayerBar.draw(field);
			offensivePlayerBar.draw(field);

			drawButtons(field);

			fill(0, 0, 0);
			textSize(20);
			text(concept.feedbackMessage, 330, 20);
			fill(176,176,176);
		};

		//*******************************************************************//
		// p5.js Event Listeners                                             //
		//*******************************************************************//

		function mousePressed() {
			playerBeingDragged = concept.mouseInPlayer(field);
		};

		function mouseDragged() {
			mouseBeingDragged = true;

			var mouseYardX = field.getYardX(mouseX);
			var mouseYardY = field.getYardY(mouseY);

			if (playerBeingDragged != null) {
				playerBeingDragged.x = mouseYardX;
				playerBeingDragged.y = mouseYardY;
			}

			// return false to prevent default behavior
			return false;
		};

		function mouseReleased() {
			if (mouseX > 0 && mouseX < field.width && mouseY > 0 && mouseY < field.height) {
				// Hide the notes and calls and their input fields and then put
				// them back if they should be there.
				hideCallsInput();
				hideNotesAndCallsInput();
				updateNotesAndCalls();

				var button_selected = document.getElementById("selected");
				if (button_selected != null) {
					unhideNotesAndCallsInput(concept.name);
				}

				// If the mouse is being dragged don't do any of the click actions.
				if (mouseBeingDragged === true) {
					mouseBeingDragged = false;
					playerBeingDragged = null;
					return false;
				}

				// If a button is displayed and clicked then call it's click
				// function and return.
				for (i in buttons) {
					if (buttons[i].isMouseInside(field)) {
						for (j in buttons) {
							if (j != i) {
								buttons[j].setUnclicked();
							}
						}

						buttons[i].click();
						return false;
					}
				}

				// Handle clicks on players in the Concept
				var currentPlayerSelected = concept.getSelected()[0];
				var newPlayerSelected = concept.mouseInPlayer(field);
				var mouseYardX = field.getYardX(mouseX);
				var mouseYardY = field.getYardY(mouseY);

				if (currentPlayerSelected != null && newPlayerSelected != null) {
					if (newPlayerSelected === currentPlayerSelected) {
						for (i in buttons) {
							buttons[i].setUnclicked();
						}

						concept.clearSelected();
						updateNotesAndCalls();
						return false;
					} else if (currentPlayerSelected.unit === newPlayerSelected.unit) {
						for (i in buttons) {
							buttons[i].setUnclicked();
						}

						concept.clearSelected();
						newPlayerSelected.click();
						unhideNotesAndCallsInput(newPlayerSelected.pos);
						unhideCallsInput(newPlayerSelected.pos);
						updateNotesAndCalls();

						if (newPlayerSelected.pos === "QB") {
							buttons[0].setClicked();
						} else if (newPlayerSelected.eligible) {
							buttons[3].setClicked();
						} else if (!newPlayerSelected.eligible) {
							buttons[4].setClicked();
						}

						return false;
					}
				}

				// If the buttons are selected add the appropriate assignments
				if (mouseX > 0 && mouseX < field.width && mouseY > defensivePlayerBar.height && mouseY < (field.height - offensivePlayerBar.height) && currentPlayerSelected) {
					if (buttons[0].clicked === true) {
						currentPlayerSelected.dropback.push([mouseYardX, mouseYardY]);
						return false;
					} else if (buttons[1].clicked === true) {
						currentPlayerSelected.motionCoords.push([mouseYardX, mouseYardY]);
						return false;
					} else if (buttons[2].clicked === true) {
						currentPlayerSelected.run.push([mouseYardX, mouseYardY]);
						return false;
					} else if (buttons[3].clicked === true) {
						currentPlayerSelected.route.push([mouseYardX, mouseYardY]);
						return false;
					} else if (buttons[4].clicked === true) {
						var block;
						if (newPlayerSelected != null && newPlayerSelected.unit === "defense") {
							block = new BlockType({
								type: 1,
								player: newPlayerSelected,
								x: mouseYardX, y: mouseYardY
							});
						} else {
							block = new BlockType({
								type: 0,
								x: mouseYardX, y: mouseYardY
							});
						}

						currentPlayerSelected.blockingAssignmentArray.push(block);
						return false;
					}else if(currentPlayerSelected.unit === "defense"){
						if(buttons[5].clicked){
							currentPlayerSelected.defensiveMovement.push([mouseYardX,mouseYardY])
						}else if(buttons[6].clicked){
							currentPlayerSelected.blitz.push([mouseYardX,mouseYardY])
						}else if(buttons[7].clicked && newPlayerSelected != null){
							currentPlayerSelected.manCoverage.push(newPlayerSelected);
						}else if(buttons[8].clicked){
							//set the arrow direction for zone coverage
							if(currentPlayerSelected.zoneCoverage == null){
								currentPlayerSelected.zoneCoverage = new ZoneAssignment({});
							}
							currentPlayerSelected.zoneCoverage.x = mouseYardX;
							currentPlayerSelected.zoneCoverage.y = mouseYardY;
						}
						return false;
					}
				}

				// If someone is currently selected and no one is clicked on
				// unselect all buttons and players. Else if no one is currently
				// selected and someone is clicked on, then select that player and
				// return.
				if (currentPlayerSelected != null && newPlayerSelected === null) {
					for (i in buttons) {
						buttons[i].setUnclicked();
					}

					concept.clearSelected();
					updateNotesAndCalls();
					return false;
				} else if (currentPlayerSelected === null && newPlayerSelected != null) {
					for (i in buttons) {
						buttons[i].setUnclicked();
					}

					newPlayerSelected.click();
					unhideNotesAndCallsInput(newPlayerSelected.pos);
					unhideCallsInput(newPlayerSelected.pos);
					updateNotesAndCalls();

					if (newPlayerSelected.pos === "QB") {
						buttons[0].setClicked();
					} else if (newPlayerSelected.eligible) {
						buttons[3].setClicked();
					} else if (!newPlayerSelected.eligible) {
						buttons[4].setClicked();
					}

					return false;
				}

				// Handle clicks on players in the PlayerBar. mouseClicked will
				// have already returned if a player on the field is clicked
				newPlayerSelected = offensivePlayerBar.mouseInPlayer(field);
				if (newPlayerSelected != null) {
					var playerToAddToConcept = new Player({
						num: newPlayerSelected.num,
						pos: newPlayerSelected.pos,
						x: Field.WIDTH / 2,
						y: field.ballYardLine,
						red: newPlayerSelected.red,
						green: newPlayerSelected.green,
						blue: newPlayerSelected.blue,
						eligible: newPlayerSelected.eligible
					});

					concept.offensivePlayers.push(playerToAddToConcept);

					return false;
				}

				// Handle clicks on players in the PlayerBar. mouseClicked will
				// have already returned if a player on the field is clicked
				newPlayerSelected = defensivePlayerBar.mouseInPlayer(field);
				if (newPlayerSelected != null) {
					var playerToAddToConcept = new Player({
						num: newPlayerSelected.num,
						pos: newPlayerSelected.pos,
						x: Field.WIDTH / 2,
						y: field.ballYardLine + field.pixelsToYards(30),
						red: newPlayerSelected.red,
						green: newPlayerSelected.green,
						blue: newPlayerSelected.blue,
						unit: newPlayerSelected.unit
					});

					concept.defensivePlayers.push(playerToAddToConcept);

					return false;
				}
			}
		};

		function keyPressed() {
			// Get the concept-name html element if it exists. This is what
			// will be updated. This all has to be before the if (mouseX
			// > 0 && mouse X ... ) statement or else there is weird buggy
			// behavior.
			var concept_name = document.getElementById("concept-name");

			// If the header box is selected update the concept name according
			// to the key press. Otherwise, create a block.
			if ($("#header-box").hasClass("selected") && concept_name != null) {
				// Get the currently selected sideview button so that you can
				// unselect it when the name in the main view's top bar is
				// changed.
				var selected = document.getElementById("selected");

				// If there was a previously selected button remove it's selected
				// id attribute and change it from btn-success to btn-primary.
				if (selected != null) {
					selected.removeAttribute("id");
					selected.removeAttribute("class");
					selected.setAttribute("class", "btn btn-primary sideview-button");
				}

				// Get the main view's top bar so that you can tell is the
				// string has become empty and needs to be replaced with a
				// placeholder message.
				var string_length = concept_name.textContent.length;

				if (keyCode == BACKSPACE) {
					if (concept_name != null) {
						if(string_length > 0) {
							concept_name.textContent = concept_name.textContent.slice(0, string_length-1);
							unhideNotesAndCallsInput(concept_name.textContent);
						}
					}
					return false;
				} else if (keyCode == 32) {
					if (concept_name != null && string_length < 100) {
						concept_name.textContent += ' ';
						unhideNotesAndCallsInput(concept_name.textContent);
					}
					return false;
				} else if (keyCode == 189) {
					if (concept_name != null && string_length < 100) {
						concept_name.textContent += '-';
						unhideNotesAndCallsInput(concept_name.textContent);
					}
					return false;
				}

			}

			if (mouseX > 0 && mouseX < field.width && mouseY > 0 && mouseY < field.height) {
				if (concept.getSelected()[0] != null) {
					var playerSelected = concept.getSelected()[0];
					var playerSelectedIndex = concept.getSelected()[1];
					var specialBlockKeys = ["Q", "W", "E", "R", "T", "Y", "U"];
					var playerStatusKeys = ["A", "S", "D", "F", "G"];
					var specialZoneKeys = ["Q", "W", "E", "R", "T"];
					var zoneTypes = ["1/4", "1/3", "1/2", "Flat", "Hook/Curl"]

					if (keyCode == BACKSPACE || keyCode == DELETE) {
						if (playerSelected.unit == "offense") {
							if (playerSelected.dropback.length > 0) {
								playerSelected.dropback.pop();
							} else if(playerSelected.run.length > 0) {
								playerSelected.run.pop();
							} else if(playerSelected.route.length > 0) {
								playerSelected.route.pop();
							} else if (playerSelected.blockingAssignmentArray.length > 0) {
								playerSelected.blockingAssignmentArray.pop();
							} else if (playerSelected.motionCoords.length > 0){
								playerSelected.motionCoords.pop();
							} else {
								concept.offensivePlayers.splice(playerSelectedIndex, 1);
							}
						} else if (playerSelected.unit == "defense") {
							if (playerSelected.manCoverage.length > 0){
								playerSelected.manCoverage.pop();
							}else if (playerSelected.zoneCoverage != null){
								playerSelected.zoneCoverage = null;
							}else if (playerSelected.blitz.length > 0){
								playerSelected.blitz.pop();
							}else if (playerSelected.defensiveMovement.length > 0) {
								playerSelected.defensiveMovement.pop();
							} else {
								concept.defensivePlayers.splice(playerSelectedIndex, 1);
							}
						}

						return false;
					}else if(playerSelected.unit === "defense"){
						var zoneTypeIndex = specialZoneKeys.indexOf(key);
						if(buttons[8].clicked && zoneTypeIndex >= 0){
							if(playerSelected.zoneCoverage == null){
								playerSelected.zoneCoverage = new ZoneAssignment({});
							}
							playerSelected.zoneCoverage.type = zoneTypes[zoneTypeIndex];
						}else if(playerStatusKeys.indexOf(key) >= 0){
							var index = 5 + playerStatusKeys.indexOf(key);
							if (buttons[index].display === true) {
								for (i in buttons) {
									if (i != index) {
										buttons[i].setUnclicked();
									} else {
										buttons[i].click();
									}
								}
							}
						}
					} else if (playerStatusKeys.indexOf(key) >= 0) {
						if(playerSelected.unit === "offense"){
							if (buttons[playerStatusKeys.indexOf(key)].display === true) {
								for (i in buttons) {
									if (i != playerStatusKeys.indexOf(key)) {
										buttons[i].setUnclicked();
									} else {
										buttons[i].click();
									}
								}
							}
						} else if (playerSelected.dropback.length === 0 && playerSelected.route.length === 0 && playerSelected.run.length === 0 && specialBlockKeys.indexOf(key) >= 0) {
							var prevX = playerSelected.x;
							var prevY = playerSelected.y;
							var blockSize = playerSelected.blockingAssignmentArray.length;

							if (blockSize > 0) {
								prevX = playerSelected.blockingAssignmentArray[blockSize - 1].x;
								prevY = playerSelected.blockingAssignmentArray[blockSize - 1].y;
							}

							var block = new BlockType({
								type: 2 + specialBlockKeys.indexOf(key),
								player: null,
								prevX: prevX,
								prevY: prevY
							});

							playerSelected.blockingAssignmentArray.push(block);

							return false;
						} else if(playerSelected.unit === "defense"){

						}

						return false;
					}
				}
			}
		};

		function keyTyped() {
			if ($("#header-box").hasClass("selected")) {
				var concept_name = document.getElementById("concept-name");

				if (concept_name === null) {
					concept_name = document.createElement("p");
					concept_name.setAttribute("id", "concept-name");
				}

				document.getElementById("header-box").appendChild(concept_name);
				var string_length = concept_name.textContent.length;

				if ((keyCode >= 48 && keyCode <= 90) || (keyCode >= 97 && keyCode <= 122)) {
					removeHeaderPlaceholder();
					removeHeaderError();

					var lcDiff = key.charCodeAt(0)-"a".charCodeAt(0);
					var ucDiff = key.charCodeAt(0)-"A".charCodeAt(0);
					var numDiff = key.charCodeAt(0)-"0".charCodeAt(0);
					if (key.length === 1 && ((lcDiff >= 0 && lcDiff < 26)) || (ucDiff >= 0 && ucDiff < 26) || (numDiff >= 0 && numDiff < 10)) {
						if (string_length <= 100){
							concept_name.textContent += key;
						}
					}

					unhideNotesAndCallsInput(concept_name.textContent);

					// return false to prevent default behavior
					return false;
				}
			}
		};

		//*******************************************************************//
		// jQuery Event Listener Functions                                   //
		//*******************************************************************//

		// When the main container is clicked unselect the interactive header.
		// This function will not call when the header is clicked because that
		// function stops propagation of the event.
		$(document).click(function(event) {
			if ($("#header-box").hasClass("selected")) {
				$("#header-box").removeClass("selected");
				var concept_name = document.getElementById("concept-name");

				if (concept_name === null) {
					addHeaderPlaceholder();
				}

				if (concept_name != null && concept_name.textContent.length === 0) {
					document.getElementById("header-box").removeChild(concept_name);
					addHeaderPlaceholder();
				}
			}
		});

		// When the header box is selected have it change colors and remove the
		// placeholder if it exists
		$("#header-box").click(function(event) {
			removeHeaderPlaceholder();
			removeHeaderError();
			$("#header-box").addClass("selected");
			concept.clearSelected();
			event.stopPropagation();
		});

		// Don't allow enter in the textarea.
		$('#note').keypress(function(event){
			if (event.keyCode === 10 || event.keyCode === 13) { event.preventDefault(); }
		});

		$("#save-button").click(function(event) {
			// Don't save the concept with one of the players selected.
			concept.clearSelected();

			var placeholder_message = document.getElementById("placeholder-message");
			var concept_name = document.getElementById("concept-name");
			var path = "/concepts/create";
			var csrf_token = "{{ csrf_token }}";

			// If there is a placeholder message remove it and add an error.
			if (placeholder_message != null) {
				removeHeaderPlaceholder();
				addHeaderError();
				return;
			}

			// I don't think this will ever happen, but I'm not sure.
			if (concept_name === null) {
				removeHeaderPlaceholder();
				addHeaderError();
				return;
			}

			// If the concept_name is 0 characters add an error.
			if (concept_name != null && concept_name.textContent.length === 0) {
				document.getElementById("header-box").removeChild(concept_name);
				addHeaderError();
				return;
			}

			// Deselect the currently selected sidebar because that concept is
			// going to dissappear from the screen.
			var selected_sideview_button = document.getElementById("selected");

			if (selected_sideview_button != null) {
				selected_sideview_button.removeAttribute("id");
				selected_sideview_button.removeAttribute("class");
				selected_sideview_button.setAttribute("class", "btn btn-primary sideview-button");
			}

			// var name gets the textContent of the header box.
			var name = concept_name.textContent;

			// Update the top interactive text bar to have a placeholder again.
			removeHeaderName();
			addHeaderPlaceholder();

			// If this concept name already exists the backend should replace
			// the old one and not save a new one. The frontend should also
			// update the existing version it has and return.
			for (var i = 0; i < concepts.length; ++i) {
				if (name === concepts[i].name) {
					concepts[i] = concept.deepCopy();
					concept.save(path, csrf_token);
					concept = new Concept({});
					return;
				}
			}

			// If the concept name does not exist the backend will create a
			// new database entry. The frontend should push this concept to
			// its concepts array and add a new button for it to the sidebar.
			concept.name = name;
			concept.team = teamID;
			concept.save(path, csrf_token);
			concepts.push(concept);

			// Create a new concept to replace the one you just saved on the
			// screen.
			concept = new Concept({});

			// Update the sidebar to include a new button for the concept that
			// was just saved.
			var sideview_buttons_div = document.getElementById("sideview-buttons");

			// Create a button for the new concept.
			var new_concept_button = document.createElement("button");
			new_concept_button.setAttribute("onclick", "changeSelectedConcept(this)");
			new_concept_button.setAttribute("name", name);
			new_concept_button.setAttribute("class", "btn btn-primary sideview-button");
			new_concept_button.textContent = name;

			// Add the new button to the sideview button div.
			sideview_buttons_div.appendChild(new_concept_button);
			return;
		});

		$("#delete-button").click(function(event) {
			// Get the currently selected sideview button.
			var selected = document.getElementById("selected");

			// If selected is not undefined then send a delete request for
			// the concept that is currently selected.
			if (selected != null) {
				// Set the path and cross-site forgery token vars.
				var path = "/concepts/create";
				var csrf_token = "{{ csrf_token }}";

				// Delete the concept from the backend.
				concept.delete(path, csrf_token);

				// Remove the concept from the concept array. If this didn't
				// happen and the user deleted a concept and added one with the
				// same name without refreshing the page, the new concept would
				// get saved properly but no button would be added dynamically
				// because a concept with the same name would exist in the
				// concepts array.
				for (var i = 0; i < concepts.length; ++i) {
					if (concept.name === concepts[i].name) {
						concepts.splice(i, 1);
						break;
					}
				}

				// Delete the button from the sidebar. After this step the
				// concept should be entirely removed from the backend and the
				// frontend.
				var sideview_buttons_div = document.getElementById("sideview-buttons");
				sideview_buttons_div.removeChild(selected);
			}

			// Update the top bar to display the Placeholder message.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			// Set concept var to equal a new Concept. This will get rid of
			// whatever is displayed on the screen.
			concept = new Concept({});
		});

		$("#zoom-in-button").click(function(event) {
			var heightInYards = field.heightInYards;
			var widthInYards = field.heightInYards * field.width / field.height;

			if (heightInYards > 25) {
				field.heightInYards -= 5;
			} else {
				field.heightInYards = 20;
			}

			resizeMainViewObjects();
		});

		$("#zoom-out-button").click(function(event) {
			var heightInYards = field.heightInYards;
			var widthInYards = field.heightInYards * field.width / field.height;

			if (heightInYards > 50) {
				field.heightInYards = 55;
			} else {
				field.heightInYards += 5;
			}

			resizeMainViewObjects();
		});

		$("#help-button").click(function(event) {
			var help_box = document.getElementById("help-box");
			var hidden = help_box.getAttribute("hidden");

			if (hidden === null) {
				help_box.setAttribute("hidden", "true");
			} else {
				help_box.removeAttribute("hidden");
			}
		});

		function changeSelectedConcept(selected) {
			// The newly selected button is the one that is clicked on. The old
			// selected button may not exist.
			var new_selected = selected;
			var old_selected = document.getElementById("selected");

			// Add a placeholder message to the top bar of the main view. If we
			// are deseclecting a button then the placeholder will stay. If we
			// are selecting a button it will get replaced with the name of the
			// concept we selected.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			// Create a new concept to replace whatever was already on screen.
			concept = new Concept({});

			// Hide notes and calls inputs and update notes and calls (get rid of them).
			hideCallsInput();
			hideNotesAndCallsInput();
			updateNotesAndCalls();

			// If there was a previously selected button remove it's selected
			// id attribute and change it from btn-success to btn-primary.
			if (old_selected != null) {
				old_selected.removeAttribute("id");
				old_selected.removeAttribute("class");
				old_selected.setAttribute("class", "btn btn-primary sideview-button");
			}

			// If the old selected button is the same as the newly selected
			// button we are done. If it isn't we need to update the newly
			// selected button and the main view area.
			if (old_selected != new_selected) {
				// Change the color of the newly selected button and set it's
				// id to
				new_selected.removeAttribute("class");
				new_selected.setAttribute("id", "selected");
				new_selected.setAttribute("class", "btn btn-success sideview-button");

				var concept_name = new_selected.getAttribute("name");

				for (i in concepts) {
					if (concept_name === concepts[i].name) {
						concept = concepts[i].deepCopy();
						break;
					}
				}

				// Show notes and calls inputs and update notes.
				unhideNotesAndCallsInput(concept_name);
				updateNotesAndCalls();

				var header_text_content = concept_name;
				concept_name = document.getElementById("concept-name");

				if (concept_name === null) {
					concept_name = document.createElement("p");
					concept_name.setAttribute("id", "concept-name");
				}

				removeHeaderPlaceholder();
				removeHeaderError();
				removeHeaderName();
				concept_name.textContent = header_text_content;
				document.getElementById("header-box").appendChild(concept_name);
			}
		};

		//*******************************************************************//
		// Utility Functions                                                 //
		//*******************************************************************//

		function removeHeaderPlaceholder() {
			var header_box = document.getElementById("header-box");
			var placeholder_message = document.getElementById("placeholder-message");
			$("#header-box").removeClass("placeholder");

			if (placeholder_message != null) {
				header_box.removeChild(placeholder_message);
			}
		};

		function removeHeaderError() {
			var header_box = document.getElementById("header-box");
			var error_message = document.getElementById("error-message");
			$("#header-box").removeClass("error");

			if (error_message != null) {
				header_box.removeChild(error_message);
			}
		};

		function removeHeaderName() {
			var header_box = document.getElementById("header-box");
			var concept_name = document.getElementById("concept-name");

			if (concept_name != null) {
				header_box.removeChild(concept_name);
			}
		};

		function addHeaderPlaceholder() {
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();

			var header_box = document.getElementById("header-box");
			$("#header-box").addClass("placeholder");

			var placeholder = document.createElement("p");
			placeholder.setAttribute("id", "placeholder-message");
			placeholder.textContent = "Enter Concept Name";
			header_box.appendChild(placeholder);
		};

		function addHeaderError() {
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();

			var header_box = document.getElementById("header-box");
			$("#header-box").removeClass("selected placeholder").addClass("error");

			var error_message = document.createElement("p");
			error_message.setAttribute("id", "error-message");
			error_message.textContent = "Invalid Concept Name";
			header_box.appendChild(error_message);
		};

		function hideNotesAndCallsInput() {
			var notes_and_calls_input = document.getElementById("notes-and-calls-input");
			notes_and_calls_input.setAttribute("hidden", "true");
		};

		function unhideNotesAndCallsInput(button_text) {
			var notes_and_calls_input = document.getElementById("notes-and-calls-input");
			notes_and_calls_input.removeAttribute("hidden");

			var add_note_button = document.getElementById("add-note-button");

			add_note_button.textContent = "Add Note for " + button_text;
		};

		function hideCallsInput() {
			var call = document.getElementById("call");
			var add_call_button = document.getElementById("add-call-button");
			call.style.display = "none";
			add_call_button.style.display = "none";
		};

		function unhideCallsInput(button_text) {
			var call = document.getElementById("call");
			var add_call_button = document.getElementById("add-call-button");
			call.style.display = "initial";
			add_call_button.style.display = "initial";

			var add_note_button = document.getElementById("add-note-button");

			add_note_button.textContent = "Add Note for " + button_text;
			add_call_button.textContent = "Set Call for " + button_text;
		};

		// updateNotesAndCalls emptys the list of formation notes and updates
		// them with the notes for the new formation.
		function updateNotesAndCalls() {
			var notes_and_calls = document.getElementById("notes-and-calls");

			// Update Concept Notes
			var concept_notes = document.getElementById("concept-notes");
			if (concept_notes != null) { concept_notes.setAttribute("hidden", "true"); }

			var concept_notes_list = document.getElementById("concept-notes-list");

			while (concept_notes_list.firstChild) {
				concept_notes_list.removeChild(concept_notes_list.firstChild);
			}

			if (concept_notes != null && concept != null && concept.notes.length > 0) {
				for (i in concept.notes) {
					var list_item = document.createElement("li");
					list_item.textContent = concept.notes[i];
					concept_notes_list.appendChild(list_item);
				}

				concept_notes.removeAttribute("hidden");
				if (notes_and_calls != null) { notes_and_calls.removeAttribute("hidden"); }
			}

			// Update Calls
			var calls = document.getElementById("calls");
			if (calls != null)  { calls.setAttribute("hidden", "true"); }

			var calls_list = document.getElementById("calls-list");

			while (calls_list.firstChild) {
				calls_list.removeChild(calls_list.firstChild);
			}

			if (calls != null && concept != null) {
				for (i in concept.offensivePlayers) {
					if (concept.offensivePlayers[i].call != "") {
						var list_item = document.createElement("li");
						list_item.textContent = concept.offensivePlayers[i].pos + ": " + concept.offensivePlayers[i].call;
						calls_list.appendChild(list_item);
						calls.removeAttribute("hidden");
						if (notes_and_calls != null) { notes_and_calls.removeAttribute("hidden"); }
					}
				}

				for (i in concept.defensivePlayers) {
					if (concept.defensivePlayers[i].call != "") {
						var list_item = document.createElement("li");
						list_item.textContent = concept.defensivePlayers[i].pos + ": " + concept.defensivePlayers[i].call;
						calls_list.appendChild(list_item);
						calls.removeAttribute("hidden");
						if (notes_and_calls != null) { notes_and_calls.removeAttribute("hidden"); }
					}
				}
			}

			// Update Player Notes
			var player_notes = document.getElementById("player-notes");
			if (player_notes != null) { player_notes.setAttribute("hidden", "true"); }

			var player_notes_list = document.getElementById("player-notes-list");

			while (player_notes_list.firstChild) {
				player_notes_list.removeChild(player_notes_list.firstChild);
			}

			var player = concept.getSelected()[0];

			if (player_notes != null && player != null && player.notes.length > 0) {
				for (i in player.notes) {
					var list_item = document.createElement("li");
					list_item.textContent = player.notes[i];
					player_notes_list.appendChild(list_item);
				}

				player_notes.removeAttribute("hidden");
				if (notes_and_calls != null) { notes_and_calls.removeAttribute("hidden"); }
			}
		};

		$("#add-note-button").click(function(event) {
			var note = document.getElementById("note");

			var path = "/concepts/create";
			var csrf_token = "{{ csrf_token }}";

			var selected = document.getElementById("selected");

			if (note.value != "" && concept != null) {
				var player = concept.getSelected()[0];
				if (player != null) {
					player.notes.push(note.value);
				} else {
					concept.notes.push(note.value);
				}

				if (selected) {
					concept.save(path, csrf_token);
				}

				updateNotesAndCalls();
			}

			note.value = "";
		});

		$("#add-call-button").click(function(event) {
			var call = document.getElementById("call");

			var path = "/concepts/create";
			var csrf_token = "{{ csrf_token }}";

			if (call.value != "" && concept != null && concept.getSelected()[0] != null) {
				concept.getSelected()[0].call = call.value;

				var button_selected = document.getElementById("selected");
				if (button_selected != null) {
					concept.clearSelected();
					concept.save(path, csrf_token);
				}

				updateNotesAndCalls();
			}

			call.value = "";
		});

		// resizeMainViewObjects resizes all of the buttons and bars in our
		// main view. It is called when the user resizes their browser.
		function resizeMainViewObjects() {
			offensivePlayerBar.width = field.width;
			offensivePlayerBar.x = 0;
			offensivePlayerBar.y = field.height - offensivePlayerBar.height;

			defensivePlayerBar.width = field.width;
			defensivePlayerBar.x = 0;

			offensivePlayerBar.resize();
			defensivePlayerBar.resize();
		};

		function drawDebuggingInfo() {
			textAlign(CENTER);

			var textX = field.width / 2;
			var textY = field.height * 0.40;
			var textYSpacing = 30;

			var mouseXString = "MouseX: " + mouseX.toFixed(2).toString() + " px, " + field.getYardX(mouseX).toFixed(2).toString() + " yd";
			var mouseYString = "MouseY: " + mouseY.toFixed(2).toString() + " px, " + field.getYardY(mouseY).toFixed(2).toString() + " yd";
			var widthString = "Width: " + field.width.toFixed(2).toString() + " px, " + field.pixelsToYards(field.width).toFixed(2).toString() + " yd";
			var heightString = "Height: " + field.height.toFixed(2).toString() + " px, " + field.pixelsToYards(field.height).toFixed(2).toString() + " yd";

			fill(0, 0, 0);
			textSize(20);

			text(mouseXString, textX, textY);

			textY += textYSpacing;
			text(mouseYString, textX, textY);

			textY += textYSpacing;
			text(widthString, textX, textY);

			textY += textYSpacing;
			text(heightString, textX, textY);

			fill(176,176,176);
		};


		function createOffensivePlayerOptions() {
			var players = [];
			var positions= []
			var player;

			{% for position in positions %}
			positions.push(["{{ position.position_type }}", "{{ position.abbreviation }}"]);
			{% endfor %}

			for (i in positions) {
				if (positions[i][0] == "Quarterback") {
					player = new Player ({
						pos: positions[i][1],
						red: 212, green: 130, blue: 130,
						siz: 2, eligible: true
					});
					players.push(player);
				}
			}

			for (i in positions) {
				if (positions[i][0] == "Offensive Lineman") {
					player = new Player ({
						pos: positions[i][1],
						red: 143, green: 29, blue: 29,
						siz: 2
					});
					players.push(player);
				}
			}

			for (i in positions) {
				if (positions[i][0] == "Skill Position") {
					player = new Player ({
						pos: positions[i][1],
						red: 255, green: 0, blue: 0,
						siz: 2, eligible: true
					});
					players.push(player);
				}
			}

			return players;
		};

		function createDefensivePlayerOptions() {
			var players = [];
			var player;

			player = new Player ({
				num: "E", pos: "E",
				red: 0, green: 0, blue: 0,
				unit: "defense",
				siz: 2
			});
			players.push(player);

			player = new Player ({
				num: "W", pos: "W",
				red: 0, green: 0, blue: 0,
				unit: "defense",
				siz: 2
			});
			players.push(player);

			player = new Player ({
				num: "T", pos: "T",
				red: 0, green: 0, blue: 0,
				unit: "defense",
				siz: 2
			});
			players.push(player);

			player = new Player ({
				num: "N", pos: "N",
				red: 0, green: 0, blue: 0,
				unit: "defense",
				siz: 2
			});
			players.push(player);

			player = new Player ({
				num: "M", pos: "M",
				red: 0, green: 0, blue: 0,
				unit: "defense",
				siz: 2
			});
			players.push(player);

			player = new Player ({
				num: "S", pos: "S",
				red: 0, green: 0, blue: 0,
				unit: "defense",
				siz: 2
			});
			players.push(player);

			player = new Player ({
				num: "SS", pos: "SS",
				red: 0, green: 0, blue: 0,
				unit: "defense",
				siz: 2
			});
			players.push(player);

			return players;
		};
	</script>
{% endblock %}
