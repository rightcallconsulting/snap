{% extends 'dashboard/base.html' %}
{% load staticfiles %}

{% block content %}
	<div class="playbook">
		<div class="action-boxes">
			<table class="action-table">
				<tbody>
					<tr>
						<td>
							<form>
								<select name="units" class="unit-form" id="unit-form" onchange="changeUnit(this)">
									{% if selected_unit == "offense" %}
										<option value="offense">
											&nbsp;&nbsp;&nbsp;OFFENSE
										</option>

										<option value="defense">
											&nbsp;&nbsp;&nbsp;DEFENSE
										</option>
									{% else %}
										<option value="defense">
											&nbsp;&nbsp;&nbsp;DEFENSE
										</option>

										<option value="offense">
											&nbsp;&nbsp;&nbsp;OFFENSE
										</option>
									{% endif %}
								</select>
							</form>
						</td>
						<td>
							{% if selected_unit == "offense" %}
								<a href="/quiz/create_formation" id="formation-link">
							{% else %}
								<a href="/quiz/create_defense_formation" id="formation-link">
							{% endif %}
									<span>
										<img class="coach-action-icon" src="{% static 'dashboard/images/plus-icon-dark.png' %}" alt="">
										&nbsp;&nbsp;&nbsp;CREATE FORMATION
									</span>
								</a>
						</td>
						<td>
							{% if selected_unit == "offense" %}
								<a href="/quiz/create_play" id="play-link">
							{% else %}
								<a href="/quiz/create_defense_formation" id="play-link">
							{% endif %}
									<span>
										<img class="coach-action-icon" src="{% static 'dashboard/images/plus-icon-dark.png' %}" alt="">
										&nbsp;&nbsp;&nbsp;CREATE PLAY
									</span>
								</a>
						</td>
					</tr>
				</tbody>
			</table>
		</div><!--/action-boxes-->
		
		<div class="main-content-area dash-col display-play-box" id="display-play-box">
			<div class="dash-header text-center">
				<span>
					<h4 id="play-image-header">
						Play
					</h4>
				</span>
			</div>
			
			<div id="display-play-box-2">
			</div>
			
			<div class="holds-play-buttons">
				<table class="button-table">
					<tr>
						<td>
							<button id="restart-button" name="button">
								{% include "quiz/refresh_button.html" %}
							</button>
						</td>
						<td>
							<button id="play-button" name="button">
								{% include "quiz/play_button.html" %}
							</button>
						</td>
						<td>
							<button id="pause-button" name="button">
								{% include "quiz/pause_button.html" %}
							</button>
						</td>
						<td>
							<button id="edit-button" name="button">
								Edit Play
							</button>
						</td>
					</tr>
				</table>
			</div>
		</div>

		<div id="sideview" class="col-md-3">
			<div id="sideview-header">
				Formations
			</div>
			<div id="sideview-buttons">
				{% for formation in formations %}
					<button class="btn btn-primary sideview-button" name="{{ formation.name }}" onclick="showPlaysInFormation(this)">
						{{ formation.name }}
					</button>
				{% endfor %}
			</div>
		</div>

		<div id="test-id" data-test-id="{{test.id}}" style="display: none;"></div>
		<div id="play-id-array" data-play-id-array="{{play_id_array}}" style="display: none;"></div>
		<div id="selected-formation" data-formation-id="0" style="display: none;"></div>
	</div><!--/playbook-->
{% endblock %}

{% block javascript %}
	<script src="{% static 'dashboard/js/jquery-1.10.2.min.js' %}"></script>
	<script type="text/javascript">
		var formations = [];
		var plays = [];
		var play;
		var teamID = document.getElementById("team-id").getAttribute("team-id");

		//*******************************************************************//
		// p5.js Animation Functions                                         //
		//*******************************************************************//
		
		//*******************************************************************//
		// p5.js Event Listeners                                             //
		//*******************************************************************//

		// showFormations loads the formation buttons back into the sideview
		// removes the back icon. It also adds all the formation buttons back.
		function showFormations(selected) {
			var sideview_header = document.getElementById("sideview-header");
			sideview_header.textContent = "Formations";

			$("#sideview-buttons").empty();

			var sideview_buttons = document.getElementById("sideview-buttons")

			for(i in formations) {
				var formation_button = document.createElement("button");
				formation_button.setAttribute("class", "btn btn-primary sideview-button");
				formation_button.setAttribute("name", formations[i].name);
				formation_button.setAttribute("onclick", "showPlaysInFormation(this)");
				formation_button.textContent = formations[i].name;

				sideview_buttons.appendChild(formation_button);
			}

			play = new Play({});
		};

		// showPlaysInFormation is called when a formation sideview button
		// is pressed. It changes the sideview header text to the name of the
		// formation selected. It also removes all the formation buttons and
		// replaces them with play buttons. It adds clickable back icon to
		// sideview header div so that you can go back to formations.
		function showPlaysInFormation(selected) {
			var sideview_header = document.getElementById("sideview-header");

			var formation_selected = selected;
			var formation_name = formation_selected.getAttribute("name");

			for (i in formations) {
				if (formation_name === formations[i].name) {
					formation_selected = formations[i].deepCopy();
					break;
				}
			}

			$("#sideview-buttons").empty();

			var back_arrow = document.createElement("i");
			back_arrow.setAttribute("id", "back-arrow");
			back_arrow.setAttribute("class", "fa fa-2x fa-angle-left");
			back_arrow.setAttribute("onclick", "showFormations(this)");

			sideview_header.textContent = formation_name;

			sideview_header.appendChild(back_arrow);

			play.fromFormation(formation_selected);

			var sideview_buttons = document.getElementById("sideview-buttons");
			
			for (i in plays) {
				if (plays[i].formation === formation_name) {
					var play_button = document.createElement("button");
					play_button.setAttribute("class", "btn btn-primary sideview-button");
					play_button.setAttribute("name", plays[i].name);
					play_button.setAttribute("onclick", "changeSelectedPlay(this)");
					play_button.textContent = plays[i].name;

					sideview_buttons.appendChild(play_button);
				}
			}
		};

		function changeSelectedPlay(selected) {
			// The newly selected button is the one that is clicked on. The old
			// selected button may not exist.
			var new_selected = selected;
			var old_selected = document.getElementById("selected");
			
			// Add a placeholder message to the top bar of the main view. If we
			// are deseclecting a button then the placeholder will stay. If we
			// are selecting a button it will get replaced with the name of the
			// formation we selected.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			// Create a new play to replace the one you just deselected on the 
			// screen. Use the same formation that you were already using.
			var formation = play.formation;
			play = new Play({});

			for (i in formations) {
				if (formation === formations[i].name) {
					play.fromFormation(formations[i]);
					break;
				}
			}

			// If there was a previously selected button remove it's selected
			// id attribute and change it from btn-success to btn-primary.
			if (old_selected != null) {
				old_selected.removeAttribute("id");
				old_selected.removeAttribute("class");
				old_selected.setAttribute("class", "btn btn-primary sideview-button");
			}

			// If the old selected button is the same as the newly selected
			// button we are done. If it isn't we need to update the newly
			// selected button and the main view area.
			if (old_selected != new_selected) {
				// Change the color of the newly selected button and set it's
				// id to 
				new_selected.removeAttribute("class");
				new_selected.setAttribute("id", "selected");
				new_selected.setAttribute("class", "btn btn-success sideview-button");

				var play_name = new_selected.getAttribute("name");

				for (i in plays) {
					if (play.formation === plays[i].formation && play_name === plays[i].name) {
						play = plays[i].deepCopy();
						break;
					}
				}

				var header_text_content = play_name;
				play_name = document.getElementById("play-name");

				if (play_name === null) {
					play_name = document.createElement("p");
					play_name.setAttribute("id", "play-name");
				}

				removeHeaderPlaceholder();
				removeHeaderError();
				removeHeaderName();
				play_name.textContent = header_text_content;
				document.getElementById("header-box").appendChild(play_name);
			}
		};
		
		//*******************************************************************//
		// jQuery Event Listener Functions                                   //
		//*******************************************************************//
		
		//*******************************************************************//
		// Utility Functions                                                 //
		//*******************************************************************//

		var playClicked;
		var formationID;
		var formationToDraw;
		var playToDraw;
		var offensivePlayToDraw; //defense
		var duplicateDefensiveFormations; //defense
		var removedPlaysFromFormation = [];
		var testID = $('#test-id').data('test-id');
		var playIDArray = $('#play-id-array').data('play-id-array');
		
		$('#draw-plays').on('mouseover', '.play', function() {
			if(playToDraw){
				playToDraw.resetPlayers(defensePlay)
				playToDraw.setAllRoutes();
			}
			playToDraw = plays.filter(function(play) {
				return play.id === Number(this.id);
			}.bind(this))[0];
			playToDraw.formation = formationToDraw;
			$('#play-image-header').text(formationToDraw.name+ ": "+ this.value);
			playScene = false;
		});

		$('#draw-plays').on('click', '.play', function() {
			$('#choose-play').data('button', this.name);
				playClicked = $(this);
		});

		$('.existing-plays').on('click', '.play-remove', function() {
			modifyPlayWithTest($(this));
			$(this).fadeOut();
			$('.show-plays #'+this.id).removeClass('play-remove-button');
			$('.show-plays #'+this.id).addClass('btn-success play-add-button');
			playIDArray = _.without(playIDArray, Number(this.id))
		});

		$("#play-button").click(function() {
			playScene = true;
		});

		$("#pause-button").click(function() {
			playScene = false;
		});

		$("#restart-button").click(function() {
			playScene = false;
			playToDraw.resetPlayers(defensePlay);
			playToDraw.setAllRoutes();
		});

		$(".formation").click(function() {
			var formationName = this.value;
			formationID = Number(this.id);
			formationToDraw = formations.filter(function(formation) {
				return formation.id === formationID;
		  	})[0];
			var playArray = []
			$('#change-plays-header').text('Plays: ' + this.value)
			$.getJSON('/quiz/teams/1/plays', function(data4, jqXHR){
				data4.forEach(function(play){
					if(play.fields.formation === formationID){
						var playObject = {
						  playName : play.fields.name,
						  ID : play.pk
						}
						playArray.push(playObject);
					}
				})
				displayPlays(playArray);
			})
			$('#play-image-header').text(formationToDraw.name+ ": ");
		});

		$(".defensive-play-button").click(function() {
			var playID = Number(this.id);
			var playName = this.value;
			defensePlayName = playName;
			var defensivePlay = null;
			var duplicateDefensiveFormations = [];
			var offensiveFormationIDs = [];
			var offensiveFormationObjects = [];
			$('.show-plays').text('');
			document.getElementById('play-image-header').innerHTML = playName;
			$.getJSON('/quiz/teams/1/defensive_formations', function(data, jqXHR){
				data.forEach(function(defensiveFormation){
					if(defensiveFormation.fields.name === playName){
						defensivePlay = createFormationFromJSON(defensiveFormation);
						if(defensiveFormation.fields.offensiveFormationID){
							offensiveFormationIDs.push(defensiveFormation.fields.offensiveFormationID);
							duplicateDefensiveFormations.push(defensivePlay);
						}
					}
				});
				$.getJSON('/quiz/teams/1/formations', function(data, jqXHR){
					data.forEach(function(formation){
						if(offensiveFormationIDs.indexOf(formation.pk) >= 0){
							var newFormation = createFormationFromJSON(formation);
							offensiveFormationObjects.push(newFormation);
						}
					});

					//Create the player objects from json for the offensive and defensive formations
					//Create buttons from offensiveFormationObjects array
					displayOffensiveFormations(offensiveFormationObjects);

					//Change the main play view to display the first version of the play
					$('#play-image-header').text(this.value);
				});
			});
		});

		// AJAX for posting
		function modifyPlayWithTest(playDomElement) {
			playID = playDomElement[0].id;
			if(playDomElement.hasClass('play-add-button')){
				addOrRemovePlay = "add"
			}
			else if (playDomElement.hasClass('play-remove-button')){
				addOrRemovePlay = "remove"
			}
				$.post( "/tests/"+ testID + "/edit", { play_id: playID, add_or_remove: addOrRemovePlay });
				if(playDomElement.hasClass('play-add-button')){
					playDomElement.addClass('play-remove-button');
					playDomElement.removeClass('play-add-button');
					playDomElement.removeClass('btn-success');
					playIDArray.push(Number(playDomElement[0].id));
					$('#formation-show-'+formationID).append("<input class='btn btn-sm bounceIn play play-remove play-remove-button' id='"+ playDomElement[0].id+"' type='submit' value='"+ playDomElement[0].value+"'>");
				}
				else if(playDomElement.hasClass('play-remove-button') && !playDomElement.hasClass('play-remove')){
					playDomElement.addClass('play-add-button');
					playDomElement.addClass('btn-success');
					playDomElement.removeClass('play-remove-button');
					playIDArray = _.without(playIDArray, Number(playDomElement[0].id))
					$('#'+playDomElement[0].id+'.play-remove').remove();
				}
		};

		function displayOffensiveFormations(formationArray){
			var drawPlays = document.getElementById('draw-offensive-formations');
			var newHTML = "<div class=\"scrollable-table\"><table class=\"formation-list three-column-table\">";
			for(var i = 0; i < formationArray.length; i++){
				if(i % 3 === 0){
					newHTML += "<tr>";
				}
				var formation = formationArray[i];
				newHTML += "<td><input class='bounceIn offensive-formation-button' id='"+ formation.id+"' type='submit' value='"+ formation.name+"'></td>";
				if(i % 3 === 2){
					newHTML += "</tr>";
				}
			}
			if(formationArray.length % 3 === 1){
				newHTML += "<td></td><td></td></tr>";
			}else if(formationArray.length % 3 === 2){
				newHTML += "<td></td></tr>";
			}
			newHTML += "</table></div>";
			drawPlays.innerHTML = newHTML;
		};

		function displayPlays(playArray) {
			var drawPlays = document.getElementById('draw-plays');
				var newHTML = "<div class=\"scrollable-table\"><table class=\"formation-list three-column-table\">";
				for(var i = 0; i < playArray.length; i++){
					if(i % 3 === 0){
						newHTML += "<tr>";
					}
					var play = playArray[i];
					if(playIDArray.includes(play.ID)){
						newHTML += "<td><input class='bounceIn play play-remove-button' id='"+ play.ID+"' type='submit' value='"+ play.playName+"'></td>";
					}
					else{
						newHTML += "<td><input class='bounceIn play play-add-button' id='"+ play.ID+"' type='submit' value='"+ play.playName+"'></td>";
					}
					if(i % 3 === 2){
						newHTML += "</tr>";
					}
				}
				if(playArray.length % 3 === 1){
					newHTML += "<td></td><td></td></tr>";
				}else if(playArray.length % 3 === 2){
					newHTML += "<td></td></tr>";
				}
				newHTML += "</table></div>";
				drawPlays.innerHTML = newHTML;
		};
	</script>
	<script language="javascript" type="text/javascript" src="{% static 'dashboard/js/edit_test.js' %}"></script>
{% endblock %}
