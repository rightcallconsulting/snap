{% extends 'dashboard/base.html' %}
{% load staticfiles %}

{% block content %}
	<div id="create-play" class="create-play padding-md">
		<select id="change-unit" onchange="changeUnit(this.value)">
			<option value="offense">Offense</option>
			<option value="defense">Defense</option>
		</select>
		<div id="help-box" hidden="true">
			<strong>Help:</strong> Select a formation from the list on the side to create a play out of that formation. Select a player in the formation by clicking on them and then add assignments using the mouse and keyboard. Change the type of assignment by clicking the top buttons or using the 'A' key for quarterback dropbacks, the 'S' key for pre-snap motion, the 'D' key for runs, the 'F' key for routes, and the 'G' key for blocking assignments. All assignments can be created by selecting that button and then clicking anywhere on the field. If blocks are selected you can also click on a defensive player to specify that player as an assignment. Additionally, the 'Q', 'W', 'E', 'R', 'T', 'Y', and 'U' keys are shortcuts for adding different predefined blocks.
			<br><br>
			Select a current play from the list of existing plays to edit it or use it as a starting point for a new play. Click the 'D' on the top of the sideview to see your scout defensive formations and implement specific versions of the selected play against a defensive look. If you save a play with the same name as a current play that play will be overwritten, otherwise a new play will be saved. To delete a current play select it from the list of existing plays and click on the trash can without changing the play's name.
		</div>

		<div id="notes-and-calls-input" class="col-md-12" hidden="true">
			<div><textarea id="note" class="snap-input snap-textarea" rows="3" cols="35"></textarea></div>
			<div><button id="add-note-button" class="btn btn-success">Add Note</button></div>
			<div><input id="call" class="snap-input snap-text" type="text" maxlength="50"></div>
			<div><button id="add-call-button" class="btn btn-success">Set Call</button></div>
		</div>

		<div id="display-box" class="col-md-8 bordered-div">
			<div id="header-box" class="interactive-header display-header placeholder">
				<p id="placeholder-message">Enter Play Name</p>
			</div>

			<div id="quiz-box">
			</div>

			<div class="mainview-buttons">
				<button id="save-button" name="button">
					<i class="fa fa-check fa-2x mainview-button-icon" title="Save Play"></i>
				</button>

				<button id="delete-button" name="button">
					<i class="fa fa-trash-o fa-2x mainview-button-icon" title="Delete Play"></i>
				</button>

				<button id="zoom-in-button" name="button">
					<i class="fa fa-search-plus fa-2x mainview-button-icon" title="Zoom in"></i>
				</button>

				<button id="zoom-out-button" name="button">
					<i class="fa fa-search-minus fa-2x mainview-button-icon" title="Zoom out"></i>
				</button>

				<button id="flip-field-button" name="button">
					<i class="fa fa-arrows-v fa-2x mainview-button-icon" title="Flip field"></i>
				</button>

				<button id="help-button" name="button">
					<i class="fa fa-question-circle-o fa-2x mainview-button-icon" title="Help"></i>
				</button>
			</div>
		</div>

		<div id="sideview" class="col-md-3">
			<div id="sideview-header">
				Formations
			</div>
			<div id="sideview-buttons">
				{% for formation in formations %}
					<button class="btn btn-primary sideview-button formation-button" name="{{ formation.name }}" onclick="showPlaysInFormation(this)">
						{{ formation.name }}
					</button>
				{% endfor %}
			</div>
		</div>

		<div id="notes-and-calls" class="col-md-12" hidden="true">
			<div id="play-notes" class="col-md-4">
				<h3 id="play-notes-header">Notes for Play</h3>
				<ul id="play-notes-list">
				</ul>
			</div>

			<div id="calls" class="col-md-4">
				<h3 id="calls-header">Calls</h3>
				<ul id="calls-list">
				</ul>
			</div>

			<div id="player-notes" class="col-md-4">
				<h3 id="player-notes-header">Notes for Player</h3>
				<ul id="player-notes-list">
				</ul>
			</div>
		</div>

	<div id="test-id" test-id="{{test.id}}" style="display: none;"></div>
	<div id="team-id" team-id="{{team.id}}" style="display: none;"></div>
	<div id="player-id" player-id="{{player.id}}" style="display: none;"></div>
{% endblock %}

{% block javascript %}
	<script src="{% static 'dashboard/js/jquery-1.10.2.min.js' %}"></script>
	<script type="text/javascript">
		var formations = [];
		var offensive_plays = [];
		var offensive_looks = [];
		var defensive_plays = [];
		var base_defenses = [];
		var play;
		var parentPlay = null;
		var scout_formations = [];
		var scout_formation;
		var formation_name_selected = "";
		var play_name_selected = "";
		var scout_formation_name_selected = "";
		var buttons = [];
		var mouseBeingDragged = false;
		var playerBeingDragged = null;
		var nodeBeingDragged = null;
		var teamID = document.getElementById("team-id").getAttribute("team-id");
		var selectedPlayerStatus = 0; //0 - blocker, 1 - route, 2 - motion

		//*******************************************************************//
		// p5.js Animation Functions                                         //
		//*******************************************************************//

		function setup() {
			var display_box = document.getElementById("display-box");
			var display_box_header = display_box.querySelector(".display-header");
			var display_box_footer = display_box.querySelector(".mainview-buttons");
			var sideview = document.getElementById("sideview");
			var height = sideview.offsetHeight - (display_box_header.offsetHeight + display_box_footer.offsetHeight);

			// 4px is the combined size of the borders on either side. What is a better way to do this?
			var width = display_box.offsetWidth - 4;

			// Create canvas and add it to the main view
			var quiz_box_div = document.getElementById("quiz-box");
			var myCanvas = createCanvas(width, height);

			field.height = height;
			field.width = width;
			field.heightInYards = 35;
			field.ballYardLine = 65;
			field.viewPoint = "offense";
			background(58, 135, 70);

			myCanvas.parent("quiz-box");

			// Load formations from Json passed from databse.
			var formationJsonFromDatabase = "";

			{% for formation in formations %}
			formationJsonFromDatabase = '{{ formation.formationJson|safe }}';
			formations.push(createFormationFromJson(JSON.parse(formationJsonFromDatabase)));
			{% endfor %}

			{% for formation in offensive_looks %}
			formationJsonFromDatabase = '{{ formation.formationJson|safe }}';
			offensive_looks.push(createFormationFromJson(JSON.parse(formationJsonFromDatabase)));
			{% endfor %}

			// Load plays from Json passed from database.
			var playJsonFromDatabase = "";

			{% for play in offensive_plays %}
			playJsonFromDatabase = '{{ play.playJson|safe }}';
			var p = createPlayFromJson(JSON.parse(playJsonFromDatabase));
			p.updateCoverageForOffense();
			offensive_plays.push(p);
			{% endfor %}

			{% for play in defensive_plays %}
			playJsonFromDatabase = '{{ play.playJson|safe }}';
			var p = createPlayFromJson(JSON.parse(playJsonFromDatabase));
			p.updateCoverageForOffense();
			defensive_plays.push(p);
			{% endfor %}

			// Load scout formations from Json passed from databse.
			var scoutFormationJsonFromDatabase = "";

			{% for scoutFormation in scoutFormations %}
			scoutFormationJsonFromDatabase = '{{ scoutFormation.formationJson|safe }}';
			scout_formations.push(createFormationFromJson(JSON.parse(scoutFormationJsonFromDatabase)));
			{% endfor %}

			{% for base_defense in base_defenses %}
			base_defenseJsonFromDatabase = '{{ base_defense.formationJson|safe }}';
			base_defenses.push(createFormationFromJson(JSON.parse(base_defenseJsonFromDatabase)));
			{% endfor %}

			// Create new Play
			play = new Play({});

			// Create buttons for selecting type of assignment
			var button = new Button ({ label: "Dropback (A)" });
			buttons.push(button);

			button = new Button ({ label: "Motion (S)" });
			buttons.push(button);

			button = new Button ({ label: "Run (D)" });
			buttons.push(button);

			button = new Button ({ label: "Route (F)" });
			buttons.push(button);

			button = new Button ({ label: "Block (G)" });
			buttons.push(button);

			var button = new Button ({ label: "Movement (A)" });
			buttons.push(button);

			button = new Button ({ label: "Rush/Blitz (S)" });
			buttons.push(button);

			button = new Button ({ label: "Man Coverage (D)" });
			buttons.push(button);

			button = new Button ({ label: "Zone Coverage (F)" });
			buttons.push(button);

			updateNotesAndCalls();

			{% if initial_view %}
				field.viewPoint = "{{initial_view}}";
				var dropdown = document.getElementById('change-unit');
				dropdown.selectedIndex = 0;
				changeUnit(field.viewPoint);
				if(field.viewPoint === "defense"){
					dropdown.selectedIndex = 1;
				}
			{% endif %}
			{% if initial_formation %}
				var initial_formation_name = "{{initial_formation}}";
				var sideview_buttons = document.getElementById("sideview-buttons").children;
				for(i in sideview_buttons){
					if(sideview_buttons[i].textContent === initial_formation_name){
						sideview_buttons[i].click();
						break;
					}
				}
			{% endif %}
			{% if initial_play %}
				var initial_play_name = "{{initial_play}}";
				var sideview_buttons = document.getElementById("sideview-buttons").children;
				for(i in sideview_buttons){
					if(sideview_buttons[i].textContent === initial_play_name){
						sideview_buttons[i].click();
						break;
					}
				}
			{% endif %}
			{% if initial_scout %}
				if(field.viewPoint === "offense"){
					showDefensiveLooks();
				}else{
					showOffensiveLooks();
				}
				var initial_scout_name = "{{initial_scout}}";
				var sideview_buttons = document.getElementById("sideview-buttons").children;
				for(i in sideview_buttons){
					if(sideview_buttons[i].textContent === initial_scout_name){
						sideview_buttons[i].click();
						break;
					}
				}
			{% endif %}

			window.onresize = function() {
				var display_box = document.getElementById("display-box");
				var display_box_header = display_box.querySelector(".display-header");
				var display_box_footer = display_box.querySelector(".display-buttons");
				var sideview = document.getElementById("sideview");
				var height = sideview.offsetHeight - (display_box_header.offsetHeight + display_box_footer.offsetHeight);
				var width = display_box.offsetWidth - 4;

				resizeCanvas(width, height);
				field.height = height;
				field.width = width;

				resizeMainViewObjects();
			};

			drawOpening();
		};

		function draw() {
			// Limitations on where offensive players can be
			var numberOfOffensivePlayers = play.offensivePlayers.length;

			for (var i = 0; i < numberOfOffensivePlayers; ++i) {
				var player = play.offensivePlayers[i];
				var playerXPixel = field.getTranslatedX(player.x);
				var playerYPixel = field.getTranslatedY(player.y);
				var playerXYard = player.x;
				var playerYYard = player.y;

				// Keep the players within the screen
				if (playerXPixel < 0) {
					player.x = field.getYardX(0);
				} else if (playerXPixel > field.width) {
					player.x = field.getYardX(field.width);
				}

				if (playerYPixel < 0) {
					player.y = player.getYardY(0);
				} else if (playerYPixel > field.height) {
					player.y = player.getYardY(field.height)
				}

				// Keep the players on the field
				if (playerXYard < 0) {
					player.x = 0;
				} else if (playerXYard > 53.33) {
					player.x = 53.33;
				}

				if (playerYYard < -10) {
					player.y = 0;
				} else if (playerYYard > field.ballYardLine) {
					player.y = field.ballYardLine;
				}

				// If a player is ineligible they must be on the line of scrimmage.
				// Otherwise if they are within a yard of the line of scrimmage they
				// should automatically snap onto the line.
				if (!player.eligible) {
					player.y = field.ballYardLine;
				} else {
					if (player.y > field.ballYardLine - 1) {
						player.y = field.ballYardLine;
					}
				}
			}

			// Limitations on where defensive players can be
			var numberOfDefensivePlayers = play.defensivePlayers.length;

			for (var i = 0; i < numberOfDefensivePlayers; ++i) {
				var player = play.defensivePlayers[i];
				var playerXPixel = field.getTranslatedX(player.x);
				var playerYPixel = field.getTranslatedY(player.y);
				var playerXYard = player.x;
				var playerYYard = player.y;

				// Keep the players within the screen
				if (playerXPixel < 0) {
					player.x = field.getYardX(0);
				} else if (playerXPixel > field.width) {
					player.x = field.getYardX(field.width);
				}

				if (playerYPixel < 0) {
					player.y = player.getYardY(0);
				} else if (playerYPixel > field.height) {
					player.y = player.getYardY(field.height)
				}

				// Keep the players on the field
				if (playerXYard < 0) {
					player.x = 0;
				} else if (playerXYard > 53.33) {
					player.x = 53.33;
				}

				if (playerYYard < field.ballYardLine+player.siz) {
					player.y = field.ballYardLine+player.siz;
				} else if (playerYYard > 110) {
					player.y = 110;
				}
			}

			// Determine which buttons should be displayed based on which, if
			// any buttons should be displayed.
			var player = play.getSelected()[0];
			for(i in buttons){
				buttons[i].display = false;
			}
			if (player != null) {
				if(player.unit === "offense"){
					if (player.dropback.length > 0) {
						buttons[0].display = true;
					} else if (player.run.length > 0) {
						buttons[2].display = true;
					} else if (player.route.length > 0) {
						buttons[3].display = true;
					} else if (player.blockingAssignmentArray.length > 0) {
						buttons[4].display = true;
					} else if (player.pos === "QB") {
						buttons[0].display = true;
						buttons[1].display = true;
						buttons[2].display = true;
						buttons[3].display = true;
						buttons[4].display = true;
					} else if (player.eligible === true) {
						buttons[1].display = true;
						buttons[2].display = true;
						buttons[3].display = true;
						buttons[4].display = true;
					} else if (player.eligible === false) {
						buttons[4].display = true;
					}
				}else{
					buttons[5].display = true;
					buttons[6].display = true;
					buttons[7].display = true;
					buttons[8].display = true;
				}

			} else {
				for (i in buttons) {
					buttons[i].setUnclicked();
					buttons[i].display = false;
				}
			}

			// Draw opening
			drawOpening();
		};

		function drawOpening() {
			field.drawBackground(play, height, width);

			//drawDebuggingInfo(); // uncomment this to have the canvas display some useful information

			play.drawAssignments(field);
			play.drawPlayers(field);
			if(playerBeingDragged != null && playerBeingDragged.unit == "defense"){
				play.drawShades(field);
			}

			var x = 10;
			var y = 10;

			for (i in buttons) {
				if (buttons[i].display === true) {
					buttons[i].x = x;
					buttons[i].y = y;

					buttons[i].draw(field);

					x += buttons[i].width*1.25;
				}
			}

			fill(0, 0, 0);
			textSize(20);
			text(play.feedbackMessage, 330, 20);
			fill(176,176,176);
		};

		function performDelete(){
			var playerSelected = play.getSelected()[0];
			if(playerSelected == null){
				return;
			}
			if (playerSelected.unit == "offense") {
				if (buttons[0].clicked && playerSelected.dropback.length > 0) {
					playerSelected.dropback.pop();
				} else if (buttons[1].clicked && playerSelected.motionCoords.length > 0){
					playerSelected.motionCoords.pop();
				} else if(buttons[2].clicked && playerSelected.run.length > 0) {
					playerSelected.run.pop();
				} else if(buttons[3].clicked && playerSelected.route.length > 0) {
					playerSelected.stepRouteBackwards();
				} else if (buttons[4].clicked && playerSelected.blockingAssignmentArray.length > 0) {
					playerSelected.blockingAssignmentArray.pop();
				} else if (playerSelected.dropback.length > 0) {
					playerSelected.dropback.pop();
				} else if(playerSelected.run.length > 0) {
					playerSelected.run.pop();
				} else if(playerSelected.route.length > 0) {
					playerSelected.stepRouteBackwards();
				} else if (playerSelected.blockingAssignmentArray.length > 0) {
					playerSelected.blockingAssignmentArray.pop();
				} else if (playerSelected.motionCoords.length > 0){
					playerSelected.motionCoords.pop();
				}
			} else if (playerSelected.unit == "defense") {
				if (buttons[5].clicked && playerSelected.defensiveMovement.length > 0){
					playerSelected.defensiveMovement.pop();
				}else if (buttons[6].clicked && playerSelected.blitz.length > 0){
					playerSelected.blitz.pop();
				}else if (buttons[7].clicked && playerSelected.manCoverage.length > 0) {
					playerSelected.manCoverage.pop();
				}else if (buttons[8].clicked && playerSelected.zoneCoverage != null){
					playerSelected.zoneCoverage = null;
				}
				else if (playerSelected.manCoverage.length > 0){
					playerSelected.manCoverage.pop();
				}else if (playerSelected.zoneCoverage != null){
					playerSelected.zoneCoverage = null;
				}else if (playerSelected.blitz.length > 0){
					playerSelected.blitz.pop();
				}else if (playerSelected.defensiveMovement.length > 0) {
					playerSelected.defensiveMovement.pop();
				}
			}
		}

		//*******************************************************************//
		// p5.js Event Listeners                                             //
		//*******************************************************************//
		function mousePressed() {
			playerBeingDragged = play.mouseInPlayer(field);
			nodeBeingDragged = play.mouseInNode(field);
		};

		function mouseDragged() {
			mouseBeingDragged = true;

			var mouseYardX = field.getYardX(mouseX);
			var mouseYardY = field.getYardY(mouseY);

			if (playerBeingDragged != null && playerBeingDragged.unit == "defense") {
				playerBeingDragged.x = mouseYardX;
				playerBeingDragged.y = mouseYardY;
			} else if (nodeBeingDragged != null) {
				var player = null;
				for(var i = 0; i < play.offensivePlayers.length; i++){
					var new_player = play.offensivePlayers[i];
					var index = new_player.routeNodes.indexOf(nodeBeingDragged);
					if(index >= 0){
						new_player.route[index][0] = mouseYardX;
						new_player.route[index][1] = mouseYardY;
					}
				}
				nodeBeingDragged.x = mouseYardX;
				nodeBeingDragged.y = mouseYardY;
			}

			// return false to prevent default behavior
			return false;
		};

		function mouseReleased() {
			// If the mouse is being dragged don't do any of the click actions.
			if (mouseBeingDragged === true) {
				mouseBeingDragged = false;
				playerBeingDragged = null;
				nodeBeingDragged = null;
				return false;
			}

			if (mouseX > 0 && mouseX < field.width && mouseY > 0 && mouseY < field.height) {
				// Hide the notes and calls and their input fields and then put
				// them back if they should be there.
				hideCallsInput();
				hideNotesAndCallsInput();
				updateNotesAndCalls();

				var button_selected = document.getElementById("selected");
				if (button_selected != null) {
					unhideNotesAndCallsInput(play.name);
				}

				// If a button is displayed and clicked then call it's click
				// function and return.
				for (i in buttons) {
					if (buttons[i].isMouseInside(field)) {
						for (j in buttons) {
							if (j != i) {
								buttons[j].setUnclicked();
							}
						}

						buttons[i].click();
						return false;
					}
				}

				// Handle clicks on players in the Play
				var currentPlayerSelected = play.getSelected()[0];
				var newPlayerSelected = play.mouseInPlayer(field);
				var mouseYardX = field.getYardX(mouseX);
				var mouseYardY = field.getYardY(mouseY);

				if (currentPlayerSelected === null && newPlayerSelected != null) {
					for (i in buttons) {
						buttons[i].setUnclicked();
					}

					newPlayerSelected.click();
					unhideNotesAndCallsInput(newPlayerSelected.pos);
					unhideCallsInput(newPlayerSelected.pos);
					updateNotesAndCalls();

					if (newPlayerSelected.unit === "defense"){
						buttons[6].setClicked();
					}
					if (newPlayerSelected.pos === "QB") {
						buttons[0].setClicked();
					} else if (newPlayerSelected.eligible) {
						buttons[3].setClicked();
					} else if (!newPlayerSelected.eligible) {
						buttons[4].setClicked();
					}

					return false;
				}

				if(currentPlayerSelected != null && currentPlayerSelected == newPlayerSelected){
						currentPlayerSelected.click();
						return false;
				}
				if(currentPlayerSelected != null && currentPlayerSelected.unit === "defense"){
					if(buttons[5].clicked){
						currentPlayerSelected.defensiveMovement.push([mouseYardX,mouseYardY])
					}else if(buttons[6].clicked){
						currentPlayerSelected.blitz.push([mouseYardX,mouseYardY])
					}else if(buttons[7].clicked && newPlayerSelected != null && newPlayerSelected.unit === "offense"){
						currentPlayerSelected.manCoverage.push(newPlayerSelected);
					}else if(buttons[8].clicked){
						//set the arrow direction for zone coverage
						if(currentPlayerSelected.zoneCoverage == null){
							currentPlayerSelected.zoneCoverage = new ZoneAssignment({});
						}
						currentPlayerSelected.zoneCoverage.x = mouseYardX;
						currentPlayerSelected.zoneCoverage.y = mouseYardY;
					}
					return false;
				}else if (currentPlayerSelected != null && newPlayerSelected != null) {
					if (newPlayerSelected === currentPlayerSelected) {
						for (i in buttons) {
							buttons[i].setUnclicked();
						}

						play.clearSelected();
						updateNotesAndCalls();
						return false;
					} else if (currentPlayerSelected.unit === newPlayerSelected.unit) {
						for (i in buttons) {
							buttons[i].setUnclicked();
						}

						play.clearSelected();
						newPlayerSelected.click();
						unhideNotesAndCallsInput(newPlayerSelected.pos);
						unhideCallsInput(newPlayerSelected.pos);
						updateNotesAndCalls();

						if (newPlayerSelected.pos === "QB") {
							buttons[0].setClicked();
						} else if (newPlayerSelected.eligible) {
							buttons[3].setClicked();
						} else if (!newPlayerSelected.eligible) {
							buttons[4].setClicked();
						}

						return false;
					}
				}

				if (buttons[0].clicked === true) {
					currentPlayerSelected.dropback.push([mouseYardX, mouseYardY]);
					return false;
				} else if (buttons[1].clicked === true) {
					currentPlayerSelected.motionCoords.push([mouseYardX, mouseYardY]);
					return false;
				} else if (buttons[2].clicked === true) {
					currentPlayerSelected.run.push([mouseYardX, mouseYardY]);
					return false;
				} else if (buttons[3].clicked === true) {
					currentPlayerSelected.addToRoute(mouseYardX, mouseYardY);
					return false;
				} else if (buttons[4].clicked === true) {
					var block;
					if (newPlayerSelected != null && newPlayerSelected.unit === "defense") {
						block = new BlockType({
							type: 1,
							player: newPlayerSelected,
							x: mouseYardX, y: mouseYardY
						});
					} else {
						block = new BlockType({
							type: 0,
							x: mouseYardX, y: mouseYardY
						});
					}

					currentPlayerSelected.blockingAssignmentArray.push(block);
					return false;
				}

				// If someone is currently selected and no one is clicked on
				// unselect all buttons and players. Else if no one is currently
				// selected and someone is clicked on, then select that player and
				// return.
				if (currentPlayerSelected != null && newPlayerSelected === null) {
					for (i in buttons) {
						buttons[i].setUnclicked();
					}

					play.clearSelected();
					updateNotesAndCalls();
					return false;
				}
			}
		};

		function keyPressed() {
			// Get the play-name html element if it exists. This is what
			// will be updated. This all has to be before the if (mouseX
			// > 0 && mouse X ... ) statement or else there is weird buggy
			// behavior.
			var play_name = document.getElementById("play-name");

			// If the header box is selected update the play name according
			// to the key press. Otherwise, create a block.
			if ($("#header-box").hasClass("selected") && play_name != null) {
				// Get the currently selected sideview button so that you can
				// unselect it when the name in the main view's top bar is
				// changed.
				var selected = document.getElementById("selected");

				// If there was a previously selected button remove it's selected
				// id attribute and change it from btn-success to btn-primary.
				if (selected != null) {
					selected.removeAttribute("id");
					selected.removeAttribute("class");
					selected.setAttribute("class", "btn btn-primary sideview-button");
				}

				// Get the main view's top bar so that you can tell is the
				// string has become empty and needs to be replaced with a
				// placeholder message.
				var string_length = play_name.textContent.length;

				if (keyCode == BACKSPACE) {
					if (play_name != null) {
						if(string_length > 0) {
							play_name.textContent = play_name.textContent.slice(0, string_length-1);
							unhideNotesAndCallsInput(play_name.textContent);
						}
					}
					return false;
				} else if (keyCode == 32) {
					if (play_name != null && string_length < 100) {
						play_name.textContent += ' ';
						unhideNotesAndCallsInput(play_name.textContent);
					}
					return false;
				} else if (keyCode == 189) {
					if (play_name != null && string_length < 100) {
						play_name.textContent += '-';
						unhideNotesAndCallsInput(play_name.textContent);
					}
					return false;
				}
			}

			if (mouseX > 0 && mouseX < field.width && mouseY > 0 && mouseY < field.height) {
				if (play.getSelected()[0] != null) {
					var playerSelected = play.getSelected()[0];
					var specialBlockKeys = ["Q", "W", "E", "R", "T", "Y", "U"];
					var playerStatusKeys = ["A", "S", "D", "F", "G"];
					var specialZoneKeys = ["Q", "W", "E", "R", "T", "Y"];
					var zoneTypes = ["1/4", "1/3", "1/2", "OUT", "HC", "CF"]

					if (keyCode == BACKSPACE || keyCode == DELETE) {
						performDelete();

						return false;
					} else if(buttons[8].clicked && specialZoneKeys.indexOf(key) >= 0){
						if(playerSelected.zoneCoverage == null){
							playerSelected.zoneCoverage = new ZoneAssignment({});
						}
						playerSelected.zoneCoverage.type = zoneTypes[specialZoneKeys.indexOf(key)];
						return false;
					} else if (buttons[2].clicked && specialBlockKeys.indexOf(key) >= 0) {
						var prevX = playerSelected.x;
						var prevY = playerSelected.y;
						var blockSize = playerSelected.blockingAssignmentArray.length;

						if (blockSize > 0) {
							prevX = playerSelected.blockingAssignmentArray[blockSize - 1].x;
							prevY = playerSelected.blockingAssignmentArray[blockSize - 1].y;
						}

						var block = new BlockType({
							type: 2 + specialBlockKeys.indexOf(key),
							player: null,
							prevX: prevX,
							prevY: prevY
						});

						playerSelected.blockingAssignmentArray.push(block);

						return false;
					} else if (playerStatusKeys.indexOf(key) >= 0) {
						var index = playerStatusKeys.indexOf(key);
						if(playerSelected.unit === "defense"){
							index += 5;
						}
						if (buttons[index].display === true) {
							for (i in buttons) {
								if (i != index) {
									buttons[i].setUnclicked();
								} else {
									buttons[i].click();
								}
							}
						}

						return false;
					} else if(buttons[3].clicked){
						var diff = key.charCodeAt(0) - "0".charCodeAt(0);
						if(diff >= 0 && diff <= 5){
							playerSelected.progressionRank = diff;
							return false;
						}
					}
				}
			}
		};

		function keyTyped() {
			if ($("#header-box").hasClass("selected")) {
				var play_name = document.getElementById("play-name");

				if (play_name === null) {
					play_name = document.createElement("p");
					play_name.setAttribute("id", "play-name");
				}

				document.getElementById("header-box").appendChild(play_name);
				var string_length = play_name.textContent.length;

				if ((keyCode >= 48 && keyCode <= 90) || (keyCode >= 97 && keyCode <= 122)) {
					removeHeaderPlaceholder();
					removeHeaderError();

					var lcDiff = key.charCodeAt(0)-"a".charCodeAt(0);
					var ucDiff = key.charCodeAt(0)-"A".charCodeAt(0);
					var numDiff = key.charCodeAt(0)-"0".charCodeAt(0);
					if (key.length === 1 && ((lcDiff >= 0 && lcDiff < 26)) || (ucDiff >= 0 && ucDiff < 26) || (numDiff >= 0 && numDiff < 10)) {
						if (string_length <= 100){
							play_name.textContent += key;
						}
					}

					unhideNotesAndCallsInput(play_name.textContent);

					// return false to prevent default behavior
					return false;
				}
			}
		};

		//*******************************************************************//
		// jQuery Event Listener Functions                                   //
		//*******************************************************************//

		// When the main container is clicked unselect the interactive header.
		// This function will not call when the header is clicked because that
		// function stops propagation of the event.
		$(document).click(function(event) {
			if ($("#header-box").hasClass("selected")) {
				$("#header-box").removeClass("selected");
				var play_name = document.getElementById("play-name");

				if (play_name === null) {
					addHeaderPlaceholder();
				}

				if (play_name != null && play_name.textContent.length === 0) {
					document.getElementById("header-box").removeChild(play_name);
					addHeaderPlaceholder();
				}
			}
		});

		// Don't allow enter in the textarea.
		$('#note').keypress(function(event){
			if (event.keyCode === 10 || event.keyCode === 13) { event.preventDefault(); }
		});

		// When the header box is selected have it change colors and remove the
		// placeholder if it exists
		$("#header-box").click(function(event) {
			removeHeaderPlaceholder();
			removeHeaderError();
			$("#header-box").addClass("selected");
			play.clearSelected();
			event.stopPropagation();
		});

		$("#save-button").click(function(event) {
			// Don't save the play with one of the players selected.
			play.clearSelected();

			var placeholder_message = document.getElementById("placeholder-message");
			var play_name = document.getElementById("play-name");
			var path = "/playbook/plays/create";
			var csrf_token = "{{ csrf_token }}";

			// If there is a placeholder message remove it and add an error.
			if (placeholder_message != null) {
				removeHeaderPlaceholder();
				addHeaderError();
				return;
			}

			// I don't think this will ever happen, but I'm not sure.
			if (play_name === null) {
				removeHeaderPlaceholder();
				addHeaderError();
				return;
			}

			// If the play_name is 0 characters add an error.
			if (play_name.textContent.length === 0) {
				document.getElementById("header-box").removeChild(play_name);
				addHeaderError();
				return;
			}

			// Deselect the currently selected sidebar because that play is
			// going to dissappear from the screen.
			var selected_sideview_button = document.getElementById("selected");

			if (selected_sideview_button != null) {
				selected_sideview_button.removeAttribute("id");
				selected_sideview_button.removeAttribute("class");
				selected_sideview_button.setAttribute("class", "btn btn-primary sideview-button");
			}

			// var name gets the textContent of the header box.
			var name = play_name.textContent;

			// Update the top interactive text bar to have a placeholder again.
			removeHeaderName();
			addHeaderPlaceholder();

			if(play.unit === "defense"){
				// If this play name already exists the backend should replace
				// the old one and not save a new one. The frontend should also
				// update the existing version it has and return.
				for(i in defensive_plays){
					if (play.formation === defensive_plays[i].formation && name === defensive_plays[i].name && play.scoutName === defensive_plays[i].scoutName) {
						defensive_plays[i] = play.deepCopy();
						play.save(path, csrf_token);
						play = defensive_plays[i].deepCopy();
						showDefense();
						return;
					}
				}

				//new play, so create new DB entry

				play.name = name;
				play.team = teamID;
				defensive_plays.push(play.deepCopy());
				play.save(path, csrf_token);

				if(play.scoutName === ""){
					var sideview_buttons_div = document.getElementById("sideview-buttons");
					var new_play_button = document.createElement("button");
					new_play_button.setAttribute("onclick", "changeSelectedDefensivePlay(this)");
					new_play_button.setAttribute("name", name);
					new_play_button.setAttribute("class", "btn btn-primary sideview-button play-button");
					new_play_button.textContent = name;

					// Add the new button to the sideview button div.
					sideview_buttons_div.appendChild(new_play_button);
					new_play_button.click();
				}else{
					showDefense();
				}
				return;
			}

			var formation = play.formation;

			for (i in formations) {
				if (formation === formations[i].name) {
					formation = formations[i].deepCopy();
					break;
				}
			}

			// If this play name already exists the backend should replace
			// the old one and not save a new one. The frontend should also
			// update the existing version it has and return.
			for (i in offensive_plays) {
				if (play.formation === offensive_plays[i].formation && name === offensive_plays[i].name && scout_formation_name_selected === offensive_plays[i].scoutName) {
					offensive_plays[i] = play.deepCopy();
					play.scoutName = scout_formation_name_selected;
					play.save(path, csrf_token);
					play = new Play({});
					play.fromFormation(formation);

					play_name_selected = "";
					showOffense();
					return;
				}
			}

			// If the play name does not exist the backend will create a
			// new database entry. The frontend should push this play to
			// its plays array and add a new button for it to the sidebar.
			play.name = name;
			play.team = teamID;
			play.scoutName = scout_formation_name_selected;
			play.save(path, csrf_token);
			offensive_plays.push(play);

			// Create a new play to replace the one you just saved on the
			// screen. Use the same formation that you were already using.
			play = new Play({});
			play.fromFormation(formation);

			// Update the sidebar to include a new button for the play that
			// was just saved.
			var sideview_buttons_div = document.getElementById("sideview-buttons");

			// If there is no scout formation selected create a button for
			// the new play.
			if (scout_formation_name_selected === "") {
				var new_play_button = document.createElement("button");
				new_play_button.setAttribute("onclick", "changeSelectedPlay(this)");
				new_play_button.setAttribute("name", name);
				new_play_button.setAttribute("class", "btn btn-primary sideview-button play-button");
				new_play_button.textContent = name;

				// Add the new button to the sideview button div.
				sideview_buttons_div.appendChild(new_play_button);
			} else {
				var check_mark = document.createElement("i");
				check_mark.setAttribute("class", "fa fa-check fa-lg sideview-button-checkmark");
				selected_sideview_button.appendChild(check_mark);
			}

			play_name_selected = "";
			showOffense();
			return;
		});

		function changeUnit(unit){
			if(unit === "offense"){
				showFormations();
			}else{
				showBaseDefenses();
			}
		}

		function deletePlayFromDatabase(){
			// Get the currently selected sideview button.
			var selected = document.getElementById("selected");

			// If selected is not undefined then send a delete request for
			// the play that is currently selected.
			if (selected != null) {
				// Remove the play from the play array. If this didn't
				// happen and the user deleted a play and added one with the
				// same name without refreshing the page, the new play would
				// get saved properly but no button would be added dynamically
				// because a play with the same name would exist in the
				// plays array.
				for (var i = 0; i < offensive_plays.length; ++i) {
					if (play.formation === offensive_plays[i].formation && play.name === offensive_plays[i].name && play.scoutName === offensive_plays[i].scoutName) {
						// Set the path and cross-site forgery token vars.
						var path = "/playbook/plays/create";
						var csrf_token = "{{ csrf_token }}";

						// Delete the play from the backend.
						play.scoutName = scout_formation_name_selected;
						play.delete(path, csrf_token);

						offensive_plays.splice(i, 1);
						break;
					}
				}

				if (scout_formation_name_selected === "") {
					// Delete the button from the sidebar. After this step the
					// play should be entirely removed from the backend and the
					// frontend.
					var sideview_buttons_div = document.getElementById("sideview-buttons");
					sideview_buttons_div.removeChild(selected);
				} else {
					var check_mark = selected.querySelector("i");
					if (check_mark != null) {
						selected.removeChild(check_mark);
					}
				}
			}

			// Update the top bar to display the Placeholder message.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			// Create a new play to replace the one you just deleted on the
			// screen. Use the same formation that you were already using.
			var formation = play.formation;
			play = new Play({});

			for (i in formations) {
				if (formation === formations[i].name) {
					play.fromFormation(formations[i]);
				}
			}

			play_name_selected = "";
			showOffense();
		}

		$("#delete-button").click(function(event) {
			performDelete();
		});

		$("#zoom-in-button").click(function(event) {
			var heightInYards = field.heightInYards;
			var widthInYards = field.heightInYards * field.width / field.height;

			if (heightInYards > 25) {
				field.heightInYards -= 5;
			} else {
				field.heightInYards = 20;
			}

			resizeMainViewObjects();
		});

		$("#zoom-out-button").click(function(event) {
			var heightInYards = field.heightInYards;
			var widthInYards = field.heightInYards * field.width / field.height;

			if (heightInYards > 50) {
				field.heightInYards = 55;
			} else {
				field.heightInYards += 5;
			}

			resizeMainViewObjects();
		});

		$("#flip-field-button").click(function(event) {
			field.flipView();
		});

		$("#help-button").click(function(event) {
			var help_box = document.getElementById("help-box");
			var hidden = help_box.getAttribute("hidden");

			if (hidden === null) {
				help_box.setAttribute("hidden", "true");
			} else {
				help_box.removeAttribute("hidden");
			}
		});

		function showBaseDefenses(){
			var sideview_header = document.getElementById("sideview-header");
			sideview_header.textContent = "Base Looks";

			// Add a placeholder message to the top bar of the main view. If we
			// are deseclecting a button then the placeholder will stay. If we
			// are selecting a button it will get replaced with the name of the
			// formation we selected.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			$("#sideview-buttons").empty();

			var sideview_buttons = document.getElementById("sideview-buttons")

			for(i in base_defenses) {
				var base_defense_button = document.createElement("button");
				base_defense_button.setAttribute("class", "btn btn-primary sideview-button formation-button");
				base_defense_button.setAttribute("name", base_defenses[i].name);
				base_defense_button.setAttribute("onclick", "showPlaysWithBaseDefense(this)");
				base_defense_button.textContent = base_defenses[i].name;

				sideview_buttons.appendChild(base_defense_button);
			}

			play = new Play({unit:"defense"});
		}

		// showFormations loads the formation buttons back into the sideview
		// removes the back icon. It also adds all the formation buttons back.
		function showFormations() {
			var sideview_header = document.getElementById("sideview-header");
			sideview_header.textContent = "Formations";

			// Add a placeholder message to the top bar of the main view. If we
			// are deseclecting a button then the placeholder will stay. If we
			// are selecting a button it will get replaced with the name of the
			// formation we selected.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			formation_name_selected = "";
			play_name_selected = "";
			scout_formation_name_selected = "";

			$("#sideview-buttons").empty();

			var sideview_buttons = document.getElementById("sideview-buttons")

			for(i in formations) {
				var formation_button = document.createElement("button");
				formation_button.setAttribute("class", "btn btn-primary sideview-button formation-button");
				formation_button.setAttribute("name", formations[i].name);
				formation_button.setAttribute("onclick", "showPlaysInFormation(this)");
				formation_button.textContent = formations[i].name;

				sideview_buttons.appendChild(formation_button);
			}

			play = new Play({});
		};

		// showPlaysInFormation is called when a formation sideview button
		// is pressed. It changes the sideview header text to the name of the
		// formation selected. It also removes all the formation buttons and
		// replaces them with play buttons. It adds clickable back icon to
		// sideview header div so that you can go back to formations.
		function showPlaysInFormation(selected) {
			var sideview_header = document.getElementById("sideview-header");

			var formation_selected = selected;
			var formation_name = formation_selected.getAttribute("name");
			formation_name_selected = formation_name;

			for (i in formations) {
				if (formation_name === formations[i].name) {
					formation_selected = formations[i].deepCopy();
					break;
				}
			}

			$("#sideview-buttons").empty();

			var back_arrow = document.createElement("i");
			back_arrow.setAttribute("id", "back-arrow");
			back_arrow.setAttribute("class", "fa fa-2x fa-angle-left");
			back_arrow.setAttribute("onclick", "showFormations()");

			sideview_header.textContent = formation_name;

			sideview_header.appendChild(back_arrow);

			play.fromFormation(formation_selected);

			var sideview_buttons = document.getElementById("sideview-buttons");

			for (i in offensive_plays) {
				if (offensive_plays[i].formation === formation_name && offensive_plays[i].scoutName === "") {
					var play_button = document.createElement("button");
					play_button.setAttribute("class", "btn btn-primary sideview-button play-button");
					play_button.setAttribute("name", offensive_plays[i].name);
					play_button.setAttribute("onclick", "changeSelectedPlay(this)");
					play_button.textContent = offensive_plays[i].name;

					sideview_buttons.appendChild(play_button);
				}
			}
		};

		// showPlaysWithBaseDefense is called when a base_defense sideview button
		// is pressed. It changes the sideview header text to the name of the
		// base_defense selected. It also removes all the base_defense buttons and
		// replaces them with defensive_play buttons. It adds clickable back icon to
		// sideview header div so that you can go back to base_defenses.
		function showPlaysWithBaseDefense(selected) {
			var sideview_header = document.getElementById("sideview-header");

			var base_defense_selected = selected;
			var base_defense_name = base_defense_selected.getAttribute("name");
			base_defense_name_selected = base_defense_name;

			for (i in base_defenses) {
				if (base_defense_name === base_defenses[i].name) {
					base_defense_selected = base_defenses[i].deepCopy();
					break;
				}
			}

			$("#sideview-buttons").empty();

			var back_arrow = document.createElement("i");
			back_arrow.setAttribute("id", "back-arrow");
			back_arrow.setAttribute("class", "fa fa-2x fa-angle-left");
			back_arrow.setAttribute("onclick", "showBaseDefenses()");

			sideview_header.textContent = base_defense_name;

			sideview_header.appendChild(back_arrow);

			play = new Play({});
			play.fromFormation(Formation.createDummyFormation());
			play.scoutFromFormation(base_defense_selected);
			play.formation = base_defense_name;
			play.unit = "defense";
			play.scoutName = "";

			var sideview_buttons = document.getElementById("sideview-buttons");

			for (i in defensive_plays) {
				if (defensive_plays[i].formation === base_defense_name && defensive_plays[i].scoutName === "") {
					var play_button = document.createElement("button");
					play_button.setAttribute("class", "btn btn-primary sideview-button play-button");
					play_button.setAttribute("name", defensive_plays[i].name);
					play_button.setAttribute("onclick", "changeSelectedDefensivePlay(this)");
					play_button.textContent = defensive_plays[i].name;

					sideview_buttons.appendChild(play_button);
				}
			}
		};

		function changeSelectedDefensivePlay(selected){
			// The newly selected button is the one that is clicked on. The old
			// selected button may not exist.
			var new_selected = selected;
			var old_selected = document.getElementById("selected");

			var sideview_header = document.getElementById("sideview-header");
			var toggle_button = document.getElementById("offense-defense-toggle");

			if (toggle_button != null) {
				sideview_header.removeChild(toggle_button);
			}

			play_name_selected = "";

			// Add a placeholder message to the top bar of the main view. If we
			// are deseclecting a button then the placeholder will stay. If we
			// are selecting a button it will get replaced with the name of the
			// formation we selected.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			// Create a new play to replace the one you just deselected on the
			// screen. Use the same formation that you were already using.
			var formation = play.formation;
			play = new Play({unit:"defense"});

			// Hide notes and calls inputs and update notes and calls (get rid of them).
			hideCallsInput();
			hideNotesAndCallsInput();
			updateNotesAndCalls();

			for (i in base_defenses) {
				if (formation === base_defenses[i].name) {
					play.fromFormation(Formation.createDummyFormation());
					play.scoutFromFormation(base_defenses[i]);
					play.unit = "defense";
					play.formation = formation;
					play.scoutName = "";
					break;
				}
			}

			// If there was a previously selected button remove it's selected
			// id attribute and change it from btn-success to btn-primary.
			if (old_selected != null) {
				old_selected.removeAttribute("id");
				old_selected.removeAttribute("class");
				old_selected.setAttribute("class", "btn btn-primary sideview-button play-button");
			}

			// If the old selected button is the same as the newly selected
			// button we are done. If it isn't we need to update the newly
			// selected button and the main view area.
			if (old_selected != new_selected) {
				// Change the color of the newly selected button and set it's
				// id to.
				new_selected.removeAttribute("class");
				new_selected.setAttribute("id", "selected");
				new_selected.setAttribute("class", "btn btn-success sideview-button play-button");

				toggle_button = document.createElement("div");
				toggle_button.setAttribute("id", "offense-defense-toggle");
				toggle_button.setAttribute("onclick", "showOffensiveLooks()");
				toggle_button.textContent = "O";
				sideview_header.appendChild(toggle_button);

				var play_name = new_selected.getAttribute("name");
				play_name_selected = play_name;

				for (i in defensive_plays) {
					if (play.formation === defensive_plays[i].formation && play_name === defensive_plays[i].name && defensive_plays[i].scoutName === ""){
						play = defensive_plays[i].deepCopy();
						break;
					}
				}

				parentPlay = play.deepCopy();

				// Show notes and calls inputs and update notes.
				unhideNotesAndCallsInput(play_name);
				updateNotesAndCalls();

				var header_text_content = play_name;
				play_name = document.getElementById("play-name");

				if (play_name === null) {
					play_name = document.createElement("p");
					play_name.setAttribute("id", "play-name");
				}

				removeHeaderPlaceholder();
				removeHeaderError();
				removeHeaderName();
				play_name.textContent = header_text_content;
				document.getElementById("header-box").appendChild(play_name);
			}
		}

		function changeSelectedPlay(selected) {
			// The newly selected button is the one that is clicked on. The old
			// selected button may not exist.
			var new_selected = selected;
			var old_selected = document.getElementById("selected");

			var sideview_header = document.getElementById("sideview-header");
			var toggle_button = document.getElementById("offense-defense-toggle");

			if (toggle_button != null) {
				sideview_header.removeChild(toggle_button);
			}

			play_name_selected = "";
			scout_formation_name_selected = "";

			// Add a placeholder message to the top bar of the main view. If we
			// are deseclecting a button then the placeholder will stay. If we
			// are selecting a button it will get replaced with the name of the
			// formation we selected.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			// Create a new play to replace the one you just deselected on the
			// screen. Use the same formation that you were already using.
			var formation = play.formation;
			play = new Play({});

			// Hide notes and calls inputs and update notes and calls (get rid of them).
			hideCallsInput();
			hideNotesAndCallsInput();
			updateNotesAndCalls();

			for (i in formations) {
				if (formation === formations[i].name) {
					play.fromFormation(formations[i]);
					break;
				}
			}

			// If there was a previously selected button remove it's selected
			// id attribute and change it from btn-success to btn-primary.
			if (old_selected != null) {
				old_selected.removeAttribute("id");
				old_selected.removeAttribute("class");
				old_selected.setAttribute("class", "btn btn-primary sideview-button play-button");
			}

			// If the old selected button is the same as the newly selected
			// button we are done. If it isn't we need to update the newly
			// selected button and the main view area.
			if (old_selected != new_selected) {
				// Change the color of the newly selected button and set it's
				// id to.
				new_selected.removeAttribute("class");
				new_selected.setAttribute("id", "selected");
				new_selected.setAttribute("class", "btn btn-success sideview-button play-button");

				toggle_button = document.createElement("div");
				toggle_button.setAttribute("id", "offense-defense-toggle");
				toggle_button.setAttribute("onclick", "showDefensiveLooks()");
				toggle_button.textContent = "D";
				sideview_header.appendChild(toggle_button);

				var play_name = new_selected.getAttribute("name");
				play_name_selected = play_name;

				for (i in offensive_plays) {
					if (play.formation === offensive_plays[i].formation && play_name === offensive_plays[i].name && offensive_plays[i].scoutName === "") {
						play = offensive_plays[i].deepCopy();
						break;
					}
				}

				parentPlay = play.deepCopy();

				// Show notes and calls inputs and update notes.
				unhideNotesAndCallsInput(play_name);
				updateNotesAndCalls();

				var header_text_content = play_name;
				play_name = document.getElementById("play-name");

				if (play_name === null) {
					play_name = document.createElement("p");
					play_name.setAttribute("id", "play-name");
				}

				removeHeaderPlaceholder();
				removeHeaderError();
				removeHeaderName();
				play_name.textContent = header_text_content;
				document.getElementById("header-box").appendChild(play_name);
			}
		};

		function showOffensiveLooks(){
			var sideview_header = document.getElementById("sideview-header");
			sideview_header.textContent = "Offensive Looks";

			var toggle_button = document.createElement("div");
			toggle_button.setAttribute("id", "offense-defense-toggle");
			toggle_button.setAttribute("onclick", "showDefense()");
			toggle_button.textContent = "D";
			sideview_header.appendChild(toggle_button);

			$("#sideview-buttons").empty();

			var sideview_buttons = document.getElementById("sideview-buttons");

			for (i in offensive_looks) {
				var scout_offense_button = document.createElement("button");
				scout_offense_button.setAttribute("class", "btn btn-primary sideview-button scout-button");
				scout_offense_button.setAttribute("name", offensive_looks[i].name);
				scout_offense_button.setAttribute("onclick", "addOffensiveLookToPlay(this)");
				scout_offense_button.textContent = offensive_looks[i].name;
				for(j in defensive_plays){
					if(defensive_plays[j].name === play.name && defensive_plays[j].formation === play.formation && defensive_plays[j].scoutName === offensive_looks[i].name){
						var check_mark = document.createElement("i");
						check_mark.setAttribute("class", "fa fa-check fa-lg sideview-button-checkmark");
						scout_offense_button.appendChild(check_mark);
						break;
					}
				}

				sideview_buttons.appendChild(scout_offense_button);
			}
		}

		// showDefensiveLooks updates the sideview to include all of the defensive
		// looks in the playbook.
		function showDefensiveLooks() {
			var sideview_header = document.getElementById("sideview-header");
			sideview_header.textContent = "Defensive Looks";

			var toggle_button = document.createElement("div");
			toggle_button.setAttribute("id", "offense-defense-toggle");
			toggle_button.setAttribute("onclick", "showOffense()");
			toggle_button.textContent = "O";
			sideview_header.appendChild(toggle_button);

			$("#sideview-buttons").empty();

			var sideview_buttons = document.getElementById("sideview-buttons");

			for (i in scout_formations) {
				var scout_defense_button = document.createElement("button");
				scout_defense_button.setAttribute("class", "btn btn-primary sideview-button scout-button");
				scout_defense_button.setAttribute("name", scout_formations[i].name);
				scout_defense_button.setAttribute("onclick", "addScoutFormationToPlay(this)");
				scout_defense_button.textContent = scout_formations[i].name;

				sideview_buttons.appendChild(scout_defense_button);
			}
		};

		function addOffensiveLookToPlay(selected){
			// The newly selected button is the one that is clicked on. The old
			// selected button may not exist.
			var new_selected = selected;
			var old_selected = document.getElementById("selected");

			if(parentPlay != null){
				play = parentPlay.deepCopy();
			}else{
				//play.removeScoutFormation();
			}

			// If there was a previously selected button remove it's selected
			// id attribute and change it from btn-success to btn-primary.
			if (old_selected != null) {
				old_selected.removeAttribute("id");
				old_selected.removeAttribute("class");
				old_selected.setAttribute("class", "btn btn-primary sideview-button scout-button");
			}

			// If the old selected button is the same as the newly selected
			// button we are done. If it isn't we need to update the newly
			// selected button and the main view area.
			if (old_selected != new_selected) {
				// Change the color of the newly selected button and set it's
				// id to
				new_selected.removeAttribute("class");
				new_selected.setAttribute("id", "selected");
				new_selected.setAttribute("class", "btn btn-success sideview-button scout-button");

				var scout_formation_name = new_selected.getAttribute("name");
				scout_formation_name_selected = scout_formation_name;

				for (i in defensive_plays) {
					if (defensive_plays[i].name === play.name && defensive_plays[i].formation === play.formation && defensive_plays[i].scoutName === scout_formation_name) {
						play = defensive_plays[i].deepCopy();
						return;
					}
				}

				for (i in offensive_looks) {
					if (scout_formation_name === offensive_looks[i].name) {
						scout_formation = offensive_looks[i];
						break;
					}
				}

				play.setScoutOffense(scout_formation);

			}
		}

		function addScoutFormationToPlay(selected) {
			// The newly selected button is the one that is clicked on. The old
			// selected button may not exist.
			var new_selected = selected;
			var old_selected = document.getElementById("selected");

			if(parentPlay != null){
				play = parentPlay.deepCopy();
			}else{
				play.removeScoutFormation();
			}

			scout_formation_name_selected = "";

			// If there was a previously selected button remove it's selected
			// id attribute and change it from btn-success to btn-primary.
			if (old_selected != null) {
				old_selected.removeAttribute("id");
				old_selected.removeAttribute("class");
				old_selected.setAttribute("class", "btn btn-primary sideview-button scout-button");
			}

			// If the old selected button is the same as the newly selected
			// button we are done. If it isn't we need to update the newly
			// selected button and the main view area.
			if (old_selected != new_selected) {
				// Change the color of the newly selected button and set it's
				// id to
				new_selected.removeAttribute("class");
				new_selected.setAttribute("id", "selected");
				new_selected.setAttribute("class", "btn btn-success sideview-button scout-button");

				var scout_formation_name = new_selected.getAttribute("name");
				scout_formation_name_selected = scout_formation_name;

				for (i in offensive_plays) {
					if (offensive_plays[i].name === play.name && offensive_plays[i].formation === play.formation && offensive_plays[i].scoutName === scout_formation_name) {
						play = offensive_plays[i].deepCopy();
						return;
					}
				}

				for (i in scout_formations) {
					if (scout_formation_name === scout_formations[i].name) {
						scout_formation = scout_formations[i];
						break;
					}
				}

				play.scoutFromFormation(scout_formation);
			}
		};

		function showDefense(){
			debugger;
			scout_formation_name_selected = "";

			// Show Plays in Base Look
			var sideview_header = document.getElementById("sideview-header");
			var sideview_buttons = document.getElementById("sideview-buttons");

			$("#sideview-buttons").empty();

			var back_arrow = document.createElement("i");
			back_arrow.setAttribute("id", "back-arrow");
			back_arrow.setAttribute("class", "fa fa-2x fa-angle-left");
			back_arrow.setAttribute("onclick", "showBaseDefenses()");

			sideview_header.textContent = play.formation;

			sideview_header.appendChild(back_arrow);

			var sideview_buttons = document.getElementById("sideview-buttons");

			for (i in defensive_plays) {
				if (defensive_plays[i].formation === play.formation  && defensive_plays[i].scoutName === "") {
					var play_button = document.createElement("button");
					play_button.setAttribute("class", "btn btn-primary sideview-button play-button");
					play_button.setAttribute("name", defensive_plays[i].name);
					play_button.setAttribute("onclick", "changeSelectedDefensivePlay(this)");
					play_button.textContent = defensive_plays[i].name;

					sideview_buttons.appendChild(play_button);

					if (defensive_plays[i].name === play.name) {
						play = defensive_plays[i].deepCopy();
					}
				}
			}

			// Change selected
			if (play_name_selected != "") {
				var play_selected_button = $("[name=\"" + play_name_selected + "\"]")[0];
				play_selected_button.removeAttribute("class");
				play_selected_button.setAttribute("id", "selected");
				play_selected_button.setAttribute("class", "btn btn-success sideview-button play-button");

				var toggle_button = document.createElement("div");
				toggle_button.setAttribute("id", "offense-defense-toggle");
				toggle_button.setAttribute("onclick", "showOffensiveLooks()");
				toggle_button.textContent = "O";
				sideview_header.appendChild(toggle_button);
			}
		}

		function showOffense() {
			scout_formation_name_selected = "";

			// Show Plays in Formation
			var sideview_header = document.getElementById("sideview-header");
			var sideview_buttons = document.getElementById("sideview-buttons");

			$("#sideview-buttons").empty();

			var back_arrow = document.createElement("i");
			back_arrow.setAttribute("id", "back-arrow");
			back_arrow.setAttribute("class", "fa fa-2x fa-angle-left");
			back_arrow.setAttribute("onclick", "showFormations()");

			sideview_header.textContent = play.formation;

			sideview_header.appendChild(back_arrow);

			var sideview_buttons = document.getElementById("sideview-buttons");

			for (i in offensive_plays) {
				if (offensive_plays[i].formation === play.formation && offensive_plays[i].scoutName === "") {
					var play_button = document.createElement("button");
					play_button.setAttribute("class", "btn btn-primary sideview-button play-button");
					play_button.setAttribute("name", offensive_plays[i].name);
					play_button.setAttribute("onclick", "changeSelectedPlay(this)");
					play_button.textContent = offensive_plays[i].name;

					sideview_buttons.appendChild(play_button);

					if (offensive_plays[i].name === play.name) {
						play = offensive_plays[i].deepCopy();
					}
				}
			}

			// Change selected
			if (play_name_selected != "") {
				var play_selected_button = $("[name=\"" + play_name_selected + "\"]")[0];
				play_selected_button.removeAttribute("class");
				play_selected_button.setAttribute("id", "selected");
				play_selected_button.setAttribute("class", "btn btn-success sideview-button play-button");

				var toggle_button = document.createElement("div");
				toggle_button.setAttribute("id", "offense-defense-toggle");
				toggle_button.setAttribute("onclick", "showDefensiveLooks()");
				toggle_button.textContent = "D";
				sideview_header.appendChild(toggle_button);
			}
		};

		//*******************************************************************//
		// Utility Functions                                                 //
		//*******************************************************************//

		function removeHeaderPlaceholder() {
			var header_box = document.getElementById("header-box");
			var placeholder_message = document.getElementById("placeholder-message");
			$("#header-box").removeClass("placeholder");

			if (placeholder_message != null) {
				header_box.removeChild(placeholder_message);
			}
		};

		function removeHeaderError() {
			var header_box = document.getElementById("header-box");
			var error_message = document.getElementById("error-message");
			$("#header-box").removeClass("error");

			if (error_message != null) {
				header_box.removeChild(error_message);
			}
		};

		function removeHeaderName() {
			var header_box = document.getElementById("header-box");
			var play_name = document.getElementById("play-name");

			if (play_name != null) {
				header_box.removeChild(play_name);
			}
		};

		function addHeaderPlaceholder() {
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();

			var header_box = document.getElementById("header-box");
			$("#header-box").addClass("placeholder");

			var placeholder = document.createElement("p");
			placeholder.setAttribute("id", "placeholder-message");
			placeholder.textContent = "Enter Play Name";
			header_box.appendChild(placeholder);
		};

		function addHeaderError() {
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();

			var header_box = document.getElementById("header-box");
			$("#header-box").removeClass("selected placeholder").addClass("error");

			var error_message = document.createElement("p");
			error_message.setAttribute("id", "error-message");
			error_message.textContent = "Invalid Play Name";
			header_box.appendChild(error_message);
		};

		function hideNotesAndCallsInput() {
			var notes_and_calls_input = document.getElementById("notes-and-calls-input");
			notes_and_calls_input.setAttribute("hidden", "true");
		};

		function unhideNotesAndCallsInput(button_text) {
			var notes_and_calls_input = document.getElementById("notes-and-calls-input");
			notes_and_calls_input.removeAttribute("hidden");

			var add_note_button = document.getElementById("add-note-button");

			add_note_button.textContent = "Add Note for " + button_text;
		};

		function hideCallsInput() {
			var call = document.getElementById("call");
			var add_call_button = document.getElementById("add-call-button");
			call.style.display = "none";
			add_call_button.style.display = "none";
		};

		function unhideCallsInput(button_text) {
			var call = document.getElementById("call");
			var add_call_button = document.getElementById("add-call-button");
			call.style.display = "initial";
			add_call_button.style.display = "initial";

			var add_note_button = document.getElementById("add-note-button");

			add_note_button.textContent = "Add Note for " + button_text;
			add_call_button.textContent = "Set Call for " + button_text;
		};

		// updateNotesAndCalls emptys the list of formation notes and updates
		// them with the notes for the new formation.
		function updateNotesAndCalls() {
			var notes_and_calls = document.getElementById("notes-and-calls");

			// Update Play Notes
			var play_notes = document.getElementById("play-notes");
			if (play_notes != null) { play_notes.setAttribute("hidden", "true"); }

			var play_notes_list = document.getElementById("play-notes-list");

			while (play_notes_list.firstChild) {
				play_notes_list.removeChild(play_notes_list.firstChild);
			}

			if (play_notes != null && play != null && play.notes.length > 0) {
				for (i in play.notes) {
					var list_item = document.createElement("li");
					list_item.textContent = play.notes[i];
					play_notes_list.appendChild(list_item);
				}

				play_notes.removeAttribute("hidden");
				if (notes_and_calls != null) { notes_and_calls.removeAttribute("hidden"); }
			}

			// Update Calls
			var calls = document.getElementById("calls");
			if (calls != null)  { calls.setAttribute("hidden", "true"); }

			var calls_list = document.getElementById("calls-list");

			while (calls_list.firstChild) {
				calls_list.removeChild(calls_list.firstChild);
			}

			if (calls != null && play != null) {
				for (i in play.offensivePlayers) {
					if (play.offensivePlayers[i].call != "") {
						var list_item = document.createElement("li");
						list_item.textContent = play.offensivePlayers[i].pos + ": " + play.offensivePlayers[i].call;
						calls_list.appendChild(list_item);
						calls.removeAttribute("hidden");
						if (notes_and_calls != null) { notes_and_calls.removeAttribute("hidden"); }
					}
				}

				for (i in play.defensivePlayers) {
					if (play.defensivePlayers[i].call != "") {
						var list_item = document.createElement("li");
						list_item.textContent = play.defensivePlayers[i].pos + ": " + play.defensivePlayers[i].call;
						calls_list.appendChild(list_item);
						calls.removeAttribute("hidden");
						if (notes_and_calls != null) { notes_and_calls.removeAttribute("hidden"); }
					}
				}
			}

			// Update Player Notes
			var player_notes = document.getElementById("player-notes");
			if (player_notes != null) { player_notes.setAttribute("hidden", "true"); }

			var player_notes_list = document.getElementById("player-notes-list");

			while (player_notes_list.firstChild) {
				player_notes_list.removeChild(player_notes_list.firstChild);
			}

			var player = play.getSelected()[0];

			if (player_notes != null && player != null && player.notes.length > 0) {
				for (i in player.notes) {
					var list_item = document.createElement("li");
					list_item.textContent = player.notes[i];
					player_notes_list.appendChild(list_item);
				}

				player_notes.removeAttribute("hidden");
				if (notes_and_calls != null) { notes_and_calls.removeAttribute("hidden"); }
			}
		};

		$("#add-note-button").click(function(event) {
			var note = document.getElementById("note");

			var path = "/playbook/plays/create";
			var csrf_token = "{{ csrf_token }}";

			var selected = document.getElementById("selected");

			if (note.value != "" && play != null) {
				var player = play.getSelected()[0];
				if (player != null) {
					player.notes.push(note.value);
				} else {
					play.notes.push(note.value);
				}

				if (selected) {
					play.save(path, csrf_token);
				}

				updateNotesAndCalls();
			}

			note.value = "";
		});

		$("#add-call-button").click(function(event) {
			var call = document.getElementById("call");

			var path = "/playbook/plays/create";
			var csrf_token = "{{ csrf_token }}";

			if (call.value != "" && play != null && play.getSelected()[0] != null) {
				play.getSelected()[0].call = call.value;

				var button_selected = document.getElementById("selected");
				if (button_selected != null) {
					play.clearSelected();
					play.save(path, csrf_token);
				}

				updateNotesAndCalls();
			}

			call.value = "";
		});

		// resizeMainViewObjects resizes all of the buttons and bars in our
		// main view. It is called when the user resizes their browser.
		function resizeMainViewObjects() {};

		function drawDebuggingInfo() {
			textAlign(CENTER);

			var textX = field.width / 2;
			var textY = field.height * 0.40;
			var textYSpacing = 30;

			var mouseXString = "MouseX: " + mouseX.toFixed(2).toString() + " px, " + field.getYardX(mouseX).toFixed(2).toString() + " yd";
			var mouseYString = "MouseY: " + mouseY.toFixed(2).toString() + " px, " + field.getYardY(mouseY).toFixed(2).toString() + " yd";
			var widthString = "Width: " + field.width.toFixed(2).toString() + " px, " + field.pixelsToYards(field.width).toFixed(2).toString() + " yd";
			var heightString = "Height: " + field.height.toFixed(2).toString() + " px, " + field.pixelsToYards(field.height).toFixed(2).toString() + " yd";

			fill(0, 0, 0);
			textSize(20);

			text(mouseXString, textX, textY);

			textY += textYSpacing;
			text(mouseYString, textX, textY);

			textY += textYSpacing;
			text(widthString, textX, textY);

			textY += textYSpacing;
			text(heightString, textX, textY);

			fill(176,176,176);
		};
	</script>
{% endblock %}
