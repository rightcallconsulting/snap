{% extends 'dashboard/base.html' %}
{% load staticfiles %}

{% block content %}
	<div id="create-play" class="create-play padding-md">
		<div id="display-box" class="col-md-8 bordered-div">
			<div id="header-box" class="interactive-header display-header placeholder">
				<p id="placeholder-message">Enter Play Name</p>
			</div>

			<div id="quiz-box">
			</div>

			<div class="display-buttons">
				<table class="button-table">
					<tr>
						<td>
							<button id="save-button" name="button">
								{% include "quiz/check_button.html" %}
							</button>
						</td>
						<td>
							<button id="clear-button" name="button">
								{% include "quiz/clear_button.html" %}
							</button>
						</td>
						<td>
							<button id="zoom-in-button" name="button">
								{% include "quiz/zoom_in_button.html" %}
							</button>
						</td>
						<td>
							<button id="zoom-out-button" name="button">
								{% include "quiz/zoom_out_button.html" %}
							</button>
						</td>
						<td>
							<button id="full-screen-button" name="button">
								{% include "quiz/full_screen_button.html" %}
							</button>
						</td>
					</tr>
				</table>
			</div>
		</div>

		<div id="sideview" class="col-md-3">
			<div id="sideview-header">
				Formations
			</div>
			<div id="sideview-buttons">
				{% for formation in formations %}
					<button class="btn btn-primary sideview-button formation-button" name="{{ formation.name }}" onclick="showPlaysInFormation(this)">
						{{ formation.name }}
					</button>
				{% endfor %}
			</div>
		</div>

	<div id="test-id" test-id="{{test.id}}" style="display: none;"></div>
	<div id="team-id" team-id="{{team.id}}" style="display: none;"></div>
	<div id="player-id" player-id="{{player.id}}" style="display: none;"></div>
{% endblock %}

{% block javascript %}
	<script src="{% static 'dashboard/js/jquery-1.10.2.min.js' %}"></script>
	<script type="text/javascript">
		var formations = [];
		var plays = [];
		var play;
		var scout_formations = [];
		var scout_formation;
		var formation_name_selected = "";
		var play_name_selected = "";
		var scout_formation_name_selected = "";
		var teamID = document.getElementById("team-id").getAttribute("team-id");

		//*******************************************************************//
		// p5.js Animation Functions                                         //
		//*******************************************************************//

		function setup() {
			var display_box = document.getElementById("display-box");
			var display_box_header = display_box.querySelector(".display-header");
			var display_box_footer = display_box.querySelector(".display-buttons");
			var sideview = document.getElementById("sideview");
			var height = sideview.offsetHeight - (display_box_header.offsetHeight + display_box_footer.offsetHeight);
			
			// 4px is the combined size of the borders on either side. What is a better way to do this?
			var width = display_box.offsetWidth - 4; 

			// Create canvas and add it to the main view
			var quiz_box_div = document.getElementById("quiz-box");
			var myCanvas = createCanvas(width, height);
			
			field.height = height;
			field.width = width;
			field.heightInYards = 35;
			field.ballYardLine = 65;
			background(58, 135, 70);

			myCanvas.parent("quiz-box");

			// Load formations from Json passed from databse.
			var formationJsonFromDatabase = "";

			{% for formation in formations %}
			formationJsonFromDatabase = '{{ formation.formationJson|safe }}';
			formations.push(createFormationFromJson(JSON.parse(formationJsonFromDatabase)));
			{% endfor %}
			
			// Load plays from Json passed from database.
			var playJsonFromDatabase = "";

			{% for play in plays %}
			playJsonFromDatabase = '{{ play.playJson|safe }}';
			plays.push(createPlayFromJson(JSON.parse(playJsonFromDatabase)));
			{% endfor %}

			// Load scout formations from Json passed from databse.
			var scoutFormationJsonFromDatabase = "";

			{% for scoutFormation in scoutFormations %}
			scoutFormationJsonFromDatabase = '{{ scoutFormation.formationJson|safe }}';
			scout_formations.push(createFormationFromJson(JSON.parse(scoutFormationJsonFromDatabase)));
			{% endfor %}

			// Create new Play
			play = new Play({});

			window.onresize = function() {
				var display_box = document.getElementById("display-box");
				var display_box_header = display_box.querySelector(".display-header");
				var display_box_footer = display_box.querySelector(".display-buttons");
				var sideview = document.getElementById("sideview");
				var height = sideview.offsetHeight - (display_box_header.offsetHeight + display_box_footer.offsetHeight);
				var width = display_box.offsetWidth - 4;

				resizeCanvas(width, height);
				field.height = height;
				field.width = width;
				
				resizeMainViewObjects();
			};

			drawOpening();
		};

		function draw() {
			// Limitations on where offensive players can be
			var numberOfOffensivePlayers = play.offensivePlayers.length;
			
			for (var i = 0; i < numberOfOffensivePlayers; ++i) {
				var player = play.offensivePlayers[i];
				var playerXPixel = field.getTranslatedX(player.x);
				var playerYPixel = field.getTranslatedY(player.y);
				var playerXYard = player.x;
				var playerYYard = player.y;

				// Keep the players within the screen
				if (playerXPixel < 0) {
					player.x = field.getYardX(0);
				} else if (playerXPixel > field.width) {
					player.x = field.getYardX(field.width);
				}

				if (playerYPixel < 0) {
					player.y = player.getYardY(0);
				} else if (playerYPixel > field.height) {
					player.y = player.getYardY(field.height)
				}

				// Keep the players on the field
				if (playerXYard < 0) {
					player.x = 0;
				} else if (playerXYard > 53.33) {
					player.x = 53.33;
				}

				if (playerYYard < -10) {
					player.y = 0;
				} else if (playerYYard > field.ballYardLine) {
					player.y = field.ballYardLine;
				}

				// If a player is ineligible they must be on the line of scrimmage.
				// Otherwise if they are within a yard of the line of scrimmage they
				// should automatically snap onto the line.
				if (!player.eligible) {
					player.y = field.ballYardLine;
				} else {
					if (player.y > field.ballYardLine - 1) {
						player.y = field.ballYardLine;
					} 
				}
			}

			// Limitations on where defensive players can be
			var numberOfDefensivePlayers = play.defensivePlayers.length;
			
			for (var i = 0; i < numberOfDefensivePlayers; ++i) {
				var player = play.defensivePlayers[i];
				var playerXPixel = field.getTranslatedX(player.x);
				var playerYPixel = field.getTranslatedY(player.y);
				var playerXYard = player.x;
				var playerYYard = player.y;

				// Keep the players within the screen
				if (playerXPixel < 0) {
					player.x = field.getYardX(0);
				} else if (playerXPixel > field.width) {
					player.x = field.getYardX(field.width);
				}

				if (playerYPixel < 0) {
					player.y = player.getYardY(0);
				} else if (playerYPixel > field.height) {
					player.y = player.getYardY(field.height)
				}

				// Keep the players on the field
				if (playerXYard < 0) {
					player.x = 0;
				} else if (playerXYard > 53.33) {
					player.x = 53.33;
				}

				if (playerYYard < field.ballYardLine+player.siz) {
					player.y = field.ballYardLine+player.siz;
				} else if (playerYYard > 110) {
					player.y = 110;
				}
			}

			// Draw opening
			drawOpening();
		};

		function drawOpening() {
			field.drawBackground(play, height, width);

			//drawDebuggingInfo(); // uncomment this to have the canvas display some useful information

			play.drawAssignments(field);
			play.drawPlayers(field);
			
			fill(0, 0, 0);
			textSize(20);
			text(play.feedbackMessage, 330, 20);
			fill(176,176,176);
		};

		//*******************************************************************//
		// p5.js Event Listeners                                             //
		//*******************************************************************//
		
		function mousePressed() {
			
			// return false to prevent default behavior
			return false;
		};

		function mouseDragged() {

			// return false to prevent default behavior
			return false;
		};

		function mouseReleased() {
			// Handle clicks on players in the Play
			var currentPlayerSelected = play.getSelected()[0];
			var newPlayerSelected = play.mouseInPlayer(field);
			var mouseYardX = field.getYardX(mouseX);
			var mouseYardY = field.getYardY(mouseY);

			// If no one is currently selected and no one is clicked on do 
			// nothing. Else if no one is currently selected and someone is 
			// clicked on, then select that player and return. Else if someone
			// is currently selected and empty field is clicked on then draw 
			// appropriate assignment based on players unit return. Else if 
			// the currently selected player is the same as the newly selected 
			// player then clear all selections and return. Else two seperate 
			// players are assigned to those variables and handle accordingly.
			if (currentPlayerSelected === null && newPlayerSelected === null) {
				// No one is selected and no one is clicked on.
				// Do nothing		
			} else if (currentPlayerSelected === null) {
				newPlayerSelected.click();
				return false;
			} else if (newPlayerSelected === null) {
				if (mouseX > 0 && mouseX < field.width && mouseY > 0 && mouseY < field.height) {
					if (currentPlayerSelected.unit === "offense") {
						if (currentPlayerSelected.eligible) {
							currentPlayerSelected.route.push([mouseYardX, mouseYardY]);
						} else {
							currentPlayerSelected.blockingAssignmentArray.push([mouseYardX, mouseYardY]);
						}
					} else if (currentPlayerSelected.unit === "defense") {
						currentPlayerSelected.defensiveMovement.push([mouseYardX, mouseYardY]);
					}
				} else {
					play.clearSelected();
				}
				return false;
			} else if (newPlayerSelected === currentPlayerSelected) {
				play.clearSelected();
				return false;
			} else if (currentPlayerSelected.unit === newPlayerSelected.unit) {
				play.clearSelected();
				newPlayerSelected.click();
				return false;
			} else if (currentPlayerSelected.unit === "offense") {
				currentPlayerSelected.blockingAssignmentArray.push(newPlayerSelected);
				return false;
			}

			// return false to prevent default behavior
			return false;
		};

		function keyPressed() {
			// Get the play-name html element if it exists. This is what
			// will be updated.
			var play_name = document.getElementById("play-name");

			// If the header box is selected update the play name according
			// to the key press. Otherwise, create a block.
			if ($("#header-box").hasClass("selected") && play_name != null) {
				// Get the currently selected sideview button so that you can
				// unselect it when the name in the main view's top bar is
				// changed.
				var selected = document.getElementById("selected");

				// If there was a previously selected button remove it's selected
				// id attribute and change it from btn-success to btn-primary.
				if (selected != null) {
					selected.removeAttribute("id");
					selected.removeAttribute("class");
					selected.setAttribute("class", "btn btn-primary sideview-button");
				}

				// Get the main view's top bar so that you can tell is the
				// string has become empty and needs to be replaced with a
				// placeholder message.
				var string_length = play_name.textContent.length;

				if (keyCode == BACKSPACE) {
					if (play_name != null) {
						if(string_length > 0) {
							play_name.textContent = play_name.textContent.slice(0, string_length-1);
						}
					}
					return false;
				} else if (keyCode == 32) {
					if (play_name != null && string_length < 100) {
						play_name.textContent += ' ';
					}
					return false;
				} else if (keyCode == 189) {
					if (formation_name != null && string_length < 100) {
						formation_name.textContent += '-';
					}
					return false;
				}
				
			} else if (play.getSelected()[0] != null) {
				var playerSelcted = play.getSelected()[0];
				var playerSelctedIndex = play.getSelected()[1];
				if (keyCode == BACKSPACE || keyCode == DELETE) {
					if (playerSelcted.unit == "offense") {
						play.offensivePlayers[playerSelctedIndex].blockingAssignmentArray = [];
						play.offensivePlayers[playerSelctedIndex].route = [];
					} else if (playerSelcted.unit == "defense") {
						play.defensivePlayers[playerSelctedIndex].defensiveMovement = [];
					}
					return false;
				} else if (key === "Q") {
					playerSelcted.blockingAssignmentArray.push("Money Block");
				} else if (key === "W") {
					playerSelcted.blockingAssignmentArray.push("Down Block Right");
				} else if (key === "E") {
					playerSelcted.blockingAssignmentArray.push("Down Block Left");
				} else if (key === "R") {
					playerSelcted.blockingAssignmentArray.push("Straight Seal Right");
				} else if (key === "T") {
					playerSelcted.blockingAssignmentArray.push("Straight Seal Left");
				} else if (key === "Y") {
					playerSelcted.blockingAssignmentArray.push("Kick Out Right");
				} else if (key === "U") {
					playerSelcted.blockingAssignmentArray.push("Kick Out Left");
				}

				return false;	
			}
		};

		function keyTyped() {
			if ($("#header-box").hasClass("selected")) {
				var play_name = document.getElementById("play-name");

				if (play_name === null) {
					play_name = document.createElement("p");
					play_name.setAttribute("id", "play-name");
				}

				document.getElementById("header-box").appendChild(play_name);
				var string_length = play_name.textContent.length;

				if ((keyCode >= 48 && keyCode <= 90) || (keyCode >= 97 && keyCode <= 122)) {
					removeHeaderPlaceholder();
					removeHeaderError();

					var lcDiff = key.charCodeAt(0)-"a".charCodeAt(0);
					var ucDiff = key.charCodeAt(0)-"A".charCodeAt(0);
					var numDiff = key.charCodeAt(0)-"0".charCodeAt(0);
					if (key.length === 1 && ((lcDiff >= 0 && lcDiff < 26)) || (ucDiff >= 0 && ucDiff < 26) || (numDiff >= 0 && numDiff < 10)) {
						if (string_length <= 100){
							play_name.textContent += key;
						}
					}

					// return false to prevent default behavior
					return false;
				}
			}
		};

		//*******************************************************************//
		// jQuery Event Listener Functions                                   //
		//*******************************************************************//
		
		// When the main container is clicked unselect the interactive header.
		// This function will not call when the header is clicked because that
		// function stops propagation of the event.
		$(document).click(function(event) {
			if ($("#header-box").hasClass("selected")) {
				$("#header-box").removeClass("selected");
				var play_name = document.getElementById("play-name");

				if (play_name === null) {
					addHeaderPlaceholder();
				}

				if (play_name != null && play_name.textContent.length === 0) {
					document.getElementById("header-box").removeChild(play_name);
					addHeaderPlaceholder();
				}
			}
		});

		// When the header box is selected have it change colors and remove the
		// placeholder if it exists
		$("#header-box").click(function(event) {
			removeHeaderPlaceholder();
			removeHeaderError();
			$("#header-box").addClass("selected");
			event.stopPropagation();
		});

		$("#save-button").click(function(event) {
			// Don't save the play with one of the players selected.
			play.clearSelected();

			var placeholder_message = document.getElementById("placeholder-message");
			var play_name = document.getElementById("play-name");
			var path = "/plays/create";
			var csrf_token = "{{ csrf_token }}";

			// If there is a placeholder message remove it and add an error.
			if (placeholder_message != null) {
				removeHeaderPlaceholder();
				addHeaderError();
				return;
			}

			// I don't think this will ever happen, but I'm not sure.
			if (play_name === null) {
				removeHeaderPlaceholder();
				addHeaderError();
				return;
			}

			// If the play_name is 0 characters add an error.
			if (play_name != null && play_name.textContent.length === 0) {
				document.getElementById("header-box").removeChild(play_name);
				addHeaderError();
				return;
			}

			// Deselect the currently selected sidebar because that play is
			// going to dissappear from the screen.
			var selected_sideview_button = document.getElementById("selected");
			
			if (selected_sideview_button != null) {
				selected_sideview_button.removeAttribute("id");
				selected_sideview_button.removeAttribute("class");
				selected_sideview_button.setAttribute("class", "btn btn-primary sideview-button");
			}

			// var name gets the textContent of the header box.
			var name = play_name.textContent;

			// Update the top interactive text bar to have a placeholder again.
			removeHeaderName();
			addHeaderPlaceholder();

			var formation = play.formation;

			for (i in formations) {
				if (formation === formations[i].name) {
					formation = formations[i].deepCopy();
					break;
				}
			}

			// If this play name already exists the backend should replace
			// the old one and not save a new one. The frontend should also
			// update the existing version it has and return.
			for (i in plays) {
				if (play.formation === plays[i].formation && name === plays[i].name && scout_formation_name_selected === plays[i].scoutName) {
					plays[i] = play.deepCopy();
					play.scoutName = scout_formation_name_selected;
					play.save(path, csrf_token);
					play = new Play({});
					play.fromFormation(formation);

					play_name_selected = "";
					showOffense();
					return;
				}
			}

			// If the play name does not exist the backend will create a
			// new database entry. The frontend should push this play to
			// its plays array and add a new button for it to the sidebar.
			play.name = name;
			play.team = teamID;
			play.scoutName = scout_formation_name_selected;
			play.save(path, csrf_token);
			plays.push(play);

			// Create a new play to replace the one you just saved on the 
			// screen. Use the same formation that you were already using.
			play = new Play({});
			play.fromFormation(formation);

			// Update the sidebar to include a new button for the play that
			// was just saved.
			var sideview_buttons_div = document.getElementById("sideview-buttons");

			// If there is no scout formation selected create a button for 
			// the new play.
			if (scout_formation_name_selected === "") {
				var new_play_button = document.createElement("button");
				new_play_button.setAttribute("onclick", "changeSelectedPlay(this)");
				new_play_button.setAttribute("name", name);
				new_play_button.setAttribute("class", "btn btn-primary sideview-button play-button");
				new_play_button.textContent = name;

				// Add the new button to the sideview button div.
				sideview_buttons_div.appendChild(new_play_button);
			} else {
				var check_mark = document.createElement("i");
				check_mark.setAttribute("class", "fa fa-check fa-lg");
				selected_sideview_button.appendChild(check_mark);
			}

			play_name_selected = "";
			showOffense();
			return;
		});

		$("#clear-button").click(function(event) {
			// Get the currently selected sideview button.
			var selected = document.getElementById("selected");

			// If selected is not undefined then send a delete request for
			// the play that is currently selected.
			if (selected != null) {
				// Remove the play from the play array. If this didn't
				// happen and the user deleted a play and added one with the
				// same name without refreshing the page, the new play would
				// get saved properly but no button would be added dynamically
				// because a play with the same name would exist in the
				// plays array.
				for (var i = 0; i < plays.length; ++i) {
					if (play.formation === plays[i].formation && play.name === plays[i].name && play.scoutName === plays[i].scoutName) {
						// Set the path and cross-site forgery token vars.
						var path = "/plays/create";
						var csrf_token = "{{ csrf_token }}";

						// Delete the play from the backend.
						play.scoutName = scout_formation_name_selected;
						play.delete(path, csrf_token);

						plays.splice(i, 1);
						break;
					}
				}

				if (scout_formation_name_selected === "") {
					// Delete the button from the sidebar. After this step the
					// play should be entirely removed from the backend and the
					// frontend.
					var sideview_buttons_div = document.getElementById("sideview-buttons");
					sideview_buttons_div.removeChild(selected);
				} else {
					var check_mark = selected.querySelector("i");
					if (check_mark != null) {
						selected.removeChild(check_mark);
					}
				}
			}

			// Update the top bar to display the Placeholder message.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			// Create a new play to replace the one you just deleted on the 
			// screen. Use the same formation that you were already using.
			var formation = play.formation;
			play = new Play({});

			for (i in formations) {
				if (formation === formations[i].name) {
					play.fromFormation(formations[i]);
				}
			}

			play_name_selected = "";
			showOffense();
		});

		$("#zoom-in-button").click(function(event) {
			var heightInYards = field.heightInYards;
			var widthInYards = field.heightInYards * field.width / field.height;
			
			if(heightInYards > 25) {
				field.heightInYards -= 5;
			} else {
				field.heightInYards = 20;
			}

			resizeMainViewObjects();
		});

		$("#zoom-out-button").click(function(event) {
			var heightInYards = field.heightInYards;
			var widthInYards = field.heightInYards * field.width / field.height;
			
			if(heightInYards > 50) {
				field.heightInYards = 55;
			} else {
				field.heightInYards += 5;
			}

			resizeMainViewObjects();
		});

		$("#full-screen-button").click(function(event) {});

		// showFormations loads the formation buttons back into the sideview
		// removes the back icon. It also adds all the formation buttons back.
		function showFormations() {
			var sideview_header = document.getElementById("sideview-header");
			sideview_header.textContent = "Formations";

			// Add a placeholder message to the top bar of the main view. If we
			// are deseclecting a button then the placeholder will stay. If we
			// are selecting a button it will get replaced with the name of the
			// formation we selected.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			formation_name_selected = "";
			play_name_selected = "";
			scout_formation_name_selected = "";

			$("#sideview-buttons").empty();

			var sideview_buttons = document.getElementById("sideview-buttons")

			for(i in formations) {
				var formation_button = document.createElement("button");
				formation_button.setAttribute("class", "btn btn-primary sideview-button formation-button");
				formation_button.setAttribute("name", formations[i].name);
				formation_button.setAttribute("onclick", "showPlaysInFormation(this)");
				formation_button.textContent = formations[i].name;

				sideview_buttons.appendChild(formation_button);
			}

			play = new Play({});
		};

		// showPlaysInFormation is called when a formation sideview button
		// is pressed. It changes the sideview header text to the name of the
		// formation selected. It also removes all the formation buttons and
		// replaces them with play buttons. It adds clickable back icon to
		// sideview header div so that you can go back to formations.
		function showPlaysInFormation(selected) {
			var sideview_header = document.getElementById("sideview-header");

			var formation_selected = selected;
			var formation_name = formation_selected.getAttribute("name");
			formation_name_selected = formation_name;

			for (i in formations) {
				if (formation_name === formations[i].name) {
					formation_selected = formations[i].deepCopy();
					break;
				}
			}

			$("#sideview-buttons").empty();

			var back_arrow = document.createElement("i");
			back_arrow.setAttribute("id", "back-arrow");
			back_arrow.setAttribute("class", "fa fa-2x fa-angle-left");
			back_arrow.setAttribute("onclick", "showFormations()");

			sideview_header.textContent = formation_name;

			sideview_header.appendChild(back_arrow);

			play.fromFormation(formation_selected);

			var sideview_buttons = document.getElementById("sideview-buttons");
			
			for (i in plays) {
				if (plays[i].formation === formation_name && plays[i].scoutName === "") {
					var play_button = document.createElement("button");
					play_button.setAttribute("class", "btn btn-primary sideview-button play-button");
					play_button.setAttribute("name", plays[i].name);
					play_button.setAttribute("onclick", "changeSelectedPlay(this)");
					play_button.textContent = plays[i].name;

					sideview_buttons.appendChild(play_button);
				}
			}
		};

		function changeSelectedPlay(selected) {
			var sideview_header = document.getElementById("sideview-header");
			var toggle_button = document.getElementById("offense-defense-toggle");

			if (toggle_button != null) {
				sideview_header.removeChild(toggle_button);
			}

			// The newly selected button is the one that is clicked on. The old
			// selected button may not exist.
			var new_selected = selected;
			var old_selected = document.getElementById("selected");

			play_name_selected = "";
			scout_formation_name_selected = "";
			
			// Add a placeholder message to the top bar of the main view. If we
			// are deseclecting a button then the placeholder will stay. If we
			// are selecting a button it will get replaced with the name of the
			// formation we selected.
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();
			addHeaderPlaceholder();

			// Create a new play to replace the one you just deselected on the 
			// screen. Use the same formation that you were already using.
			var formation = play.formation;
			play = new Play({});

			for (i in formations) {
				if (formation === formations[i].name) {
					play.fromFormation(formations[i]);
					break;
				}
			}

			// If there was a previously selected button remove it's selected
			// id attribute and change it from btn-success to btn-primary.
			if (old_selected != null) {
				old_selected.removeAttribute("id");
				old_selected.removeAttribute("class");
				old_selected.setAttribute("class", "btn btn-primary sideview-button play-button");
			}

			// If the old selected button is the same as the newly selected
			// button we are done. If it isn't we need to update the newly
			// selected button and the main view area.
			if (old_selected != new_selected) {
				// Change the color of the newly selected button and set it's
				// id to 
				new_selected.removeAttribute("class");
				new_selected.setAttribute("id", "selected");
				new_selected.setAttribute("class", "btn btn-success sideview-button play-button");

				toggle_button = document.createElement("div");
				toggle_button.setAttribute("id", "offense-defense-toggle");
				toggle_button.setAttribute("onclick", "showDefensiveLooks()");
				toggle_button.textContent = "D";
				sideview_header.appendChild(toggle_button);

				var play_name = new_selected.getAttribute("name");
				play_name_selected = play_name;

				for (i in plays) {
					if (play.formation === plays[i].formation && play_name === plays[i].name && plays[i].scoutName === "") {
						play = plays[i].deepCopy();
						break;
					}
				}

				var header_text_content = play_name;
				play_name = document.getElementById("play-name");

				if (play_name === null) {
					play_name = document.createElement("p");
					play_name.setAttribute("id", "play-name");
				}

				removeHeaderPlaceholder();
				removeHeaderError();
				removeHeaderName();
				play_name.textContent = header_text_content;
				document.getElementById("header-box").appendChild(play_name);
			}
		};

		// showDefensiveLooks updates the sideview to include all of the defensive
		// looks in the playbook.
		function showDefensiveLooks() {
			var sideview_header = document.getElementById("sideview-header");
			sideview_header.textContent = "Defensive Looks";

			var toggle_button = document.createElement("div");
			toggle_button.setAttribute("id", "offense-defense-toggle");
			toggle_button.setAttribute("onclick", "showOffense()");
			toggle_button.textContent = "O";
			sideview_header.appendChild(toggle_button);

			$("#sideview-buttons").empty();

			var sideview_buttons = document.getElementById("sideview-buttons");

			for (i in scout_formations) {
				var scout_formation_button = document.createElement("button");
				scout_formation_button.setAttribute("class", "btn btn-primary sideview-button scout-button");
				scout_formation_button.setAttribute("name", scout_formations[i].name);
				scout_formation_button.setAttribute("onclick", "addScoutFormationToPlay(this)");
				scout_formation_button.textContent = scout_formations[i].name;

				for (j in plays) {
					if (plays[j].name === play.name && plays[j].scoutName === scout_formations[i].name) {
						var check_mark = document.createElement("i");
						check_mark.setAttribute("class", "fa fa-check fa-lg");
						scout_formation_button.appendChild(check_mark);
					}
				}

				sideview_buttons.appendChild(scout_formation_button);
			}
		};

		function addScoutFormationToPlay(selected) {
			// The newly selected button is the one that is clicked on. The old
			// selected button may not exist.
			var new_selected = selected;
			var old_selected = document.getElementById("selected");
			
			play.removeScoutFormation();
			scout_formation_name_selected = "";

			// If there was a previously selected button remove it's selected
			// id attribute and change it from btn-success to btn-primary.
			if (old_selected != null) {
				old_selected.removeAttribute("id");
				old_selected.removeAttribute("class");
				old_selected.setAttribute("class", "btn btn-primary sideview-button scout-button");
			}

			// If the old selected button is the same as the newly selected
			// button we are done. If it isn't we need to update the newly
			// selected button and the main view area.
			if (old_selected != new_selected) {
				// Change the color of the newly selected button and set it's
				// id to 
				new_selected.removeAttribute("class");
				new_selected.setAttribute("id", "selected");
				new_selected.setAttribute("class", "btn btn-success sideview-button scout-button");

				var scout_formation_name = new_selected.getAttribute("name");
				scout_formation_name_selected = scout_formation_name;

				for (i in plays) {
					if (plays[i].name === play.name && plays[i].scoutName === scout_formation_name) {
						play = plays[i].deepCopy();
						return;
					}
				}

				for (i in scout_formations) {
					if (scout_formation_name === scout_formations[i].name) {
						scout_formation = scout_formations[i].deepCopy();
						break;
					}
				}

				play.scoutFromFormation(scout_formation);
			}
		};

		function showOffense() {
			scout_formation_name_selected = "";

			// Show Plays in Formation
			var sideview_header = document.getElementById("sideview-header");
			var sideview_buttons = document.getElementById("sideview-buttons");

			$("#sideview-buttons").empty();

			var back_arrow = document.createElement("i");
			back_arrow.setAttribute("id", "back-arrow");
			back_arrow.setAttribute("class", "fa fa-2x fa-angle-left");
			back_arrow.setAttribute("onclick", "showFormations()");

			sideview_header.textContent = formation_name_selected;

			sideview_header.appendChild(back_arrow);

			var sideview_buttons = document.getElementById("sideview-buttons");
			
			for (i in plays) {
				if (plays[i].formation === formation_name_selected && plays[i].scoutName === "") {
					var play_button = document.createElement("button");
					play_button.setAttribute("class", "btn btn-primary sideview-button play-button");
					play_button.setAttribute("name", plays[i].name);
					play_button.setAttribute("onclick", "changeSelectedPlay(this)");
					play_button.textContent = plays[i].name;

					sideview_buttons.appendChild(play_button);
				}

				if (plays[i].name === play.name && plays[i].scoutName === "") {
					play = plays[i].deepCopy();
				}
			}
			
			// Change selected
			if (play_name_selected != "") {
				var play_selected_button = $("[name=\"" + play_name_selected + "\"]")[0];
				play_selected_button.removeAttribute("class");
				play_selected_button.setAttribute("id", "selected");
				play_selected_button.setAttribute("class", "btn btn-success sideview-button play-button");

				var toggle_button = document.createElement("div");
				toggle_button.setAttribute("id", "offense-defense-toggle");
				toggle_button.setAttribute("onclick", "showDefensiveLooks()");
				toggle_button.textContent = "D";
				sideview_header.appendChild(toggle_button);
			}
		};

		//*******************************************************************//
		// Utility Functions                                                 //
		//*******************************************************************//

		function removeHeaderPlaceholder() {
			var header_box = document.getElementById("header-box");
			var placeholder_message = document.getElementById("placeholder-message");
			$("#header-box").removeClass("placeholder");
			
			if (placeholder_message != null) {
				header_box.removeChild(placeholder_message);
			}
		};

		function removeHeaderError() {
			var header_box = document.getElementById("header-box");
			var error_message = document.getElementById("error-message");
			$("#header-box").removeClass("error");
			
			if (error_message != null) {
				header_box.removeChild(error_message);
			}
		};

		function removeHeaderName() {
			var header_box = document.getElementById("header-box");
			var play_name = document.getElementById("play-name");

			if (play_name != null) {
				header_box.removeChild(play_name);
			}
		};

		function addHeaderPlaceholder() {
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();

			var header_box = document.getElementById("header-box");
			$("#header-box").addClass("placeholder");

			var placeholder = document.createElement("p");
			placeholder.setAttribute("id", "placeholder-message");
			placeholder.textContent = "Enter Play Name";
			header_box.appendChild(placeholder);
		};

		function addHeaderError() {
			removeHeaderPlaceholder();
			removeHeaderError();
			removeHeaderName();

			var header_box = document.getElementById("header-box");
			$("#header-box").removeClass("selected placeholder").addClass("error");

			var error_message = document.createElement("p");
			error_message.setAttribute("id", "error-message");
			error_message.textContent = "Invalid Play Name";
			header_box.appendChild(error_message);
		};

		// resizeMainViewObjects resizes all of the buttons and bars in our
		// main view. It is called when the user resizes their browser.
		function resizeMainViewObjects() {};

		function drawDebuggingInfo() {
			textAlign(CENTER);

			var textX = field.width / 2;
			var textY = field.height * 0.40;
			var textYSpacing = 30;

			var mouseXString = "MouseX: " + mouseX.toFixed(2).toString() + " px, " + field.getYardX(mouseX).toFixed(2).toString() + " yd";
			var mouseYString = "MouseY: " + mouseY.toFixed(2).toString() + " px, " + field.getYardY(mouseY).toFixed(2).toString() + " yd";
			var widthString = "Width: " + field.width.toFixed(2).toString() + " px, " + field.pixelsToYards(field.width).toFixed(2).toString() + " yd";
			var heightString = "Height: " + field.height.toFixed(2).toString() + " px, " + field.pixelsToYards(field.height).toFixed(2).toString() + " yd";

			fill(0, 0, 0);
			textSize(20);

			text(mouseXString, textX, textY);
			
			textY += textYSpacing;
			text(mouseYString, textX, textY);
			
			textY += textYSpacing;
			text(widthString, textX, textY);
			
			textY += textYSpacing;
			text(heightString, textX, textY);

			fill(176,176,176);
		};
	</script>
{% endblock %}
