# Configure the project language, language version, and Django enviornment
language: python
python: 2.7
env: DJANGO_VERSION=1.8.3

# Include postgres for tests
services:
  - postgres

# Create the database needed for testing
build:
  ci:
    - psql -c 'CREATE ROLE shippable WITH superuser;' -U postgres
    - psql -c 'CREATE DATABASE test_snapdb;' -U postgres

# Install requirements
install:
  - sudo apt-get install libjpeg-dev # To prevent Pillow install from failing -- Not sure we need it long term 
  - pip install -r requirements.txt

# Make folders for the reports
before_script:
   - mkdir -p shippable/testresults
   - mkdir -p shippable/codecoverage

# Command to run tests
script:
  - which python && coverage run manage.py test --settings=snap.settings.local --parallel
  - which python && coverage html --fail-under=55 --title="Snap Coverage report" -o shippable/codecoverage/coverage.xml

# Integrations with email and Slack
integrations:
  notifications:
    - integrationName: email
      type: email
      recipients:
        - dylan@rightcallconsulting.com
        - sam@rightcallconsulting.com
      branches:
        only:
          - master
          - develop
    - integrationName: Shippable-Slack
      type: slack 
      recipients:
        - "#devops"